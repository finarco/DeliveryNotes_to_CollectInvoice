{% extends "base.html" %}
{% block content %}
<h4>Dodacie listy</h4>
<form method="get" class="row g-3 mb-3">
  <div class="col-md-3">
    <select class="form-select" name="confirmed">
      <option value="">-- stav --</option>
      <option value="true" {% if request.args.get('confirmed') == 'true' %}selected{% endif %}>Potvrdené</option>
      <option value="false" {% if request.args.get('confirmed') == 'false' %}selected{% endif %}>Nepotvrdené</option>
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-outline-primary" type="submit">Filtrovať</button>
  </div>
</form>
<form method="post" class="card card-body shadow-sm mb-4">
  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Objednávky (rovnaká skupina)</label>
      <select class="form-select" name="order_ids" multiple required>
        {% for order in orders %}
        <option value="{{ order.id }}">
          #{{ order.id }} - {{ order.partner.name }}
          {% if order.partner.group_code %}({{ order.partner.group_code }}){% endif %}
        </option>
        {% endfor %}
      </select>
      <div class="form-text">Vyberte jednu alebo viac objednávok v rovnakej skupine.</div>
    </div>
    <div class="col-md-3">
      <label class="form-label">Plánovaný termín dodania</label>
      <input type="datetime-local" class="form-control" name="planned_delivery_datetime">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="show_prices" {{ "checked" if app_config.show_prices_default }}>
        <label class="form-check-label">Zobraziť ceny</label>
      </div>
    </div>
  </div>
  <hr>
  <h6>Neobjednané položky</h6>
  <div class="row g-3">
    {% for product in products %}
    <div class="col-md-3">
      <label class="form-label">{{ product.name }}</label>
      <input class="form-control" type="number" name="extra_{{ product.id }}" min="0" value="0">
    </div>
    {% endfor %}
  </div>
  <h6 class="mt-3">Kombinácie</h6>
  <div class="row g-3">
    {% for bundle in bundles %}
    <div class="col-md-3">
      <label class="form-label">{{ bundle.name }}</label>
      <input class="form-control" type="number" name="bundle_{{ bundle.id }}" min="0" value="0">
    </div>
    {% endfor %}
  </div>
  <div class="mt-3">
    <button class="btn btn-primary" type="submit">Vytvoriť dodací list</button>
  </div>
</form>
<table class="table table-striped bg-white shadow-sm">
  <thead>
    <tr>
      <th>ID</th>
      <th>Partner</th>
      <th>Objednávky</th>
      <th>Plán/Skutočnosť</th>
      <th>Ceny</th>
      <th>Stav</th>
      <th>PDF</th>
    </tr>
  </thead>
  <tbody>
    {% for delivery in delivery_notes %}
    <tr>
      <td>{{ delivery.id }}</td>
      <td>{{ delivery.primary_order.partner.name if delivery.primary_order }}</td>
      <td>
        <ul class="list-unstyled mb-0">
          {% for link in delivery.orders %}
          <li>#{{ link.order.id }} - {{ link.order.partner.name }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        {{ delivery.planned_delivery_datetime }}<br>
        {{ delivery.actual_delivery_datetime }}
      </td>
      <td>
        {% if current_user and current_user.role != 'customer' and delivery.show_prices %}
          Áno
        {% else %}
          Nie
        {% endif %}
      </td>
      <td>
        {% if delivery.confirmed %}
          <span class="badge bg-success">Potvrdený</span>
          <form method="post" action="{{ url_for('delivery.unconfirm_delivery', delivery_id=delivery.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-danger" type="submit">Zrušiť potvrdenie</button>
          </form>
        {% else %}
          <span class="badge bg-warning text-dark">Nepotvrdený</span>
          <form method="post" action="{{ url_for('delivery.confirm_delivery', delivery_id=delivery.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-primary" type="submit">Potvrdiť</button>
          </form>
        {% endif %}
      </td>
      <td><a class="btn btn-sm btn-outline-primary" href="{{ url_for('delivery.delivery_pdf', delivery_id=delivery.id) }}">PDF</a></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('delivery.list_delivery_notes', page=p, confirmed=request.args.get('confirmed')) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
{% endblock %}
