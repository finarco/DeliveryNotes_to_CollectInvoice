{% extends "base.html" %}

{% block page_title %}Faktúry{% endblock %}

{% block page_actions %}
<div style="display: flex; gap: 12px;">
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">Vytvoriť faktúru</button>
  <button type="button" class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#addManualItemModal">Manuálna položka</button>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/invoices.css') }}">
{% endblock %}

{% block content %}

{# Stats Dashboard #}
<div class="invoice-stats-grid">
  <div class="invoice-stat-card total">
    <div class="invoice-stat-label">Celkové tržby</div>
    <div class="invoice-stat-value">
      {{ "%.2f"|format(total_revenue|default(0)) }}<span class="invoice-stat-suffix">€</span>
    </div>
  </div>

  <div class="invoice-stat-card paid">
    <div class="invoice-stat-label">Zaplatené</div>
    <div class="invoice-stat-value">
      {{ "%.2f"|format(paid_amount|default(0)) }}<span class="invoice-stat-suffix">€</span>
    </div>
  </div>

  <div class="invoice-stat-card unpaid">
    <div class="invoice-stat-label">Neuhradené</div>
    <div class="invoice-stat-value">
      {{ "%.2f"|format(unpaid_amount|default(0)) }}<span class="invoice-stat-suffix">€</span>
    </div>
  </div>

  <div class="invoice-stat-card overdue">
    <div class="invoice-stat-label">Po splatnosti</div>
    <div class="invoice-stat-value">
      {{ "%.2f"|format(overdue_amount|default(0)) }}<span class="invoice-stat-suffix">€</span>
    </div>
  </div>
</div>

{# Table Header #}
<div class="invoice-table-header">
  <h3 class="invoice-table-title">Zoznam faktúr</h3>
</div>

<div class="modal fade" id="addInvoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nová zúčtovacia faktúra</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Partner</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invPartnerSearch" placeholder="Hľadať partnera..." autocomplete="off">
                <input type="hidden" name="partner_id" id="invPartnerIdHidden" required>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#inlineAddPartnerModal">+ Nový</button>
              </div>
              <div id="invPartnerResults" class="list-group position-absolute" style="z-index:1050;display:none;max-height:200px;overflow-y:auto;"></div>
              <select class="form-select d-none" id="invPartnerSelect">
                <option value="">-- vyberte partnera --</option>
                {% for partner in partners %}
                <option value="{{ partner.id }}">{{ partner.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          {# Delivery notes area — hidden until partner selected #}
          <div id="invDnArea" style="display:none;" class="mt-3">
            <h6>Nevyfakturované dodacie listy</h6>
            <div id="invDnList" class="row g-2">
              <div class="text-muted">Načítavam...</div>
            </div>
          </div>

          <hr>
          <h6>Položky faktúry</h6>
          <table class="table table-sm" id="invItemsTable">
            <thead>
              <tr>
                <th>Zdroj</th>
                <th>Popis</th>
                <th style="width:80px">Množstvo</th>
                <th style="width:100px">Jedn. cena</th>
                <th style="width:80px">DPH %</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody id="invItemsBody">
              <!-- rows added dynamically by JS -->
            </tbody>
          </table>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addInvoiceManualRow()">+ Manuálna položka</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Vytvoriť zúčtovaciu faktúru</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="addManualItemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="manual-item-form" method="post" data-url-template="{{ url_for('invoices.add_invoice_item', invoice_id=0) }}">
        <div class="modal-header">
          <h5 class="modal-title">Manuálna položka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">ID faktúry</label>
              <input class="form-control" id="manual-invoice-id" name="invoice_id" required>
            </div>
            <div class="col-md-5">
              <label class="form-label">Popis</label>
              <input class="form-control" name="description" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Množstvo</label>
              <input class="form-control" name="quantity" type="number" min="1" value="1" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Jedn. cena</label>
              <input class="form-control" name="unit_price" type="number" step="0.01" value="0" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Pridať položku</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editInvoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="editInvoiceForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť faktúru</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Stav</label>
              <select class="form-select" name="status">
                {% for status in valid_invoice_statuses %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <hr>
          <h6>Položky faktúry</h6>
          <div id="editInvReadonlyNotice" class="alert alert-warning d-none">Faktúra je uzamknutá — položky nie je možné upraviť.</div>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Popis</th>
                <th style="width:80px">Množstvo</th>
                <th style="width:100px">Jedn. cena</th>
                <th style="width:80px">DPH %</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody id="editInvItemsBody"></tbody>
          </table>
          <div id="editInvItemButtons" class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addEditInvManualRow()">+ Manuálna položka</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary" id="editInvSaveBtn">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
document.getElementById('manual-item-form').addEventListener('submit', function(e) {
  var invoiceId = document.getElementById('manual-invoice-id').value;
  if (invoiceId) {
    this.action = this.dataset.urlTemplate.replace('/0/', '/' + invoiceId + '/');
  }
});

// -- Invoice creation: partner-first flow --
var _invItemIdx = 0;

var invPartnerSelect = document.getElementById('invPartnerSelect');
if (invPartnerSelect) {
  invPartnerSelect.addEventListener('change', function() {
    var pid = this.value;
    var area = document.getElementById('invDnArea');
    var list = document.getElementById('invDnList');
    if (!pid) {
      area.style.display = 'none';
      return;
    }
    area.style.display = 'block';
    list.innerHTML = '<div class="text-muted">Načítavam...</div>';
    loadPartnerDeliveryNotes(pid);
  });
}

function loadPartnerDeliveryNotes(partnerId) {
  fetch('/invoices/partner-delivery-notes/' + partnerId)
    .then(function(r) { return r.json(); })
    .then(function(dns) {
      var list = document.getElementById('invDnList');
      if (dns.length === 0) {
        list.innerHTML = '<div class="text-muted col-12">Žiadne nevyfakturované dodacie listy.</div>';
        return;
      }
      var html = '';
      dns.forEach(function(dn) {
        var itemSummary = dn.items.map(function(it) { return it.description; }).join(', ');
        html += '<div class="col-md-6">' +
          '<div class="form-check border rounded p-2">' +
          '<input class="form-check-input inv-dn-checkbox" type="checkbox" name="delivery_note_ids" value="' + dn.id + '" ' +
          'data-items=\'' + JSON.stringify(dn.items).replace(/'/g, "&#39;") + '\' ' +
          'data-dn-id="' + dn.id + '" data-dn-number="' + dn.note_number + '" onchange="onInvDnToggle(this)">' +
          '<label class="form-check-label">' +
          '<strong>' + dn.note_number + '</strong> — ' + dn.partner_name +
          ' <small class="text-muted">(' + dn.created_at + ')</small>' +
          '<br><small class="text-muted">' + itemSummary + '</small>' +
          '</label>' +
          '</div></div>';
      });
      list.innerHTML = html;
    });
}

function onInvDnToggle(checkbox) {
  var dnId = checkbox.dataset.dnId;
  var dnNumber = checkbox.dataset.dnNumber;
  var items = JSON.parse(checkbox.dataset.items);
  var tbody = document.getElementById('invItemsBody');
  if (checkbox.checked) {
    items.forEach(function(item) {
      var i = _invItemIdx++;
      var html = '<tr data-source-dn="' + dnId + '">' +
        '<td><input type="hidden" name="items[' + i + '][type]" value="delivery">' + dnNumber + '</td>' +
        '<td><input class="form-control form-control-sm" type="text" name="items[' + i + '][description]" value="' + dnNumber + ': ' + item.description.replace(/"/g, '&quot;') + '">' +
          '<input type="hidden" name="items[' + i + '][source_delivery_id]" value="' + dnId + '">' +
        '</td>' +
        '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="' + item.quantity + '"></td>' +
        '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + item.unit_price + '"></td>' +
        '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][vat_rate]" value="20"></td>' +
        '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
        '</tr>';
      tbody.insertAdjacentHTML('beforeend', html);
    });
  } else {
    tbody.querySelectorAll('tr[data-source-dn="' + dnId + '"]').forEach(function(row) {
      row.remove();
    });
  }
}

function addInvoiceManualRow() {
  var i = _invItemIdx++;
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="manual">Manuálna</td>' +
    '<td><input class="form-control form-control-sm" type="text" name="items[' + i + '][description]" placeholder="Popis položky" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="0" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][vat_rate]" value="20"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('invItemsBody').insertAdjacentHTML('beforeend', html);
}

// Reset modal state when closed
document.getElementById('addInvoiceModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('invItemsBody').innerHTML = '';
  document.getElementById('invDnArea').style.display = 'none';
  _invItemIdx = 0;
});
</script>
<div class="modal fade" id="viewInvoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail faktúry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-3">
          <dt class="col-sm-4">ID</dt><dd class="col-sm-8" id="viewInvoiceId"></dd>
          <dt class="col-sm-4">Číslo faktúry</dt><dd class="col-sm-8" id="viewInvoiceNumber"></dd>
          <dt class="col-sm-4">Partner</dt><dd class="col-sm-8" id="viewInvoicePartner"></dd>
          <dt class="col-sm-4">Stav</dt><dd class="col-sm-8" id="viewInvoiceStatus"></dd>
          <dt class="col-sm-4">Spolu bez DPH</dt><dd class="col-sm-8" id="viewInvoiceTotal"></dd>
          <dt class="col-sm-4">Spolu s DPH</dt><dd class="col-sm-8" id="viewInvoiceTotalVat"></dd>
        </dl>
        <h6>Položky</h6>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Popis</th>
              <th>Množstvo</th>
              <th>Jedn. cena</th>
              <th>DPH %</th>
              <th>Suma DPH</th>
              <th>Spolu s DPH</th>
            </tr>
          </thead>
          <tbody id="viewInvoiceItemsBody"></tbody>
          <tfoot id="viewInvoiceItemsFoot"></tfoot>
        </table>
        <div id="viewInvoiceQr" class="text-center mt-3" style="display:none;">
          <h6>QR kód na platbu</h6>
          <img id="viewInvoiceQrImg" src="" alt="PayBySquare QR" style="max-width:200px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>
<div class="table-container">
<table class="table">
  <thead>
    <tr>
      <th>Číslo</th>
      <th>Partner</th>
      <th>Dátum</th>
      <th>Splatnosť</th>
      <th>Suma</th>
      <th>Stav</th>
      <th>Akcie</th>
    </tr>
  </thead>
  <tbody>
    {% for invoice in invoices %}
    <tr class="{{ 'paid' if invoice.status == 'paid' else ('overdue' if invoice.status == 'overdue' else '') }}">
      <td>{{ invoice.invoice_number or invoice.id }}</td>
      <td>{{ invoice.partner.name }}</td>
      <td>{{ invoice.created_at.strftime('%d.%m.%Y') if invoice.created_at else '-' }}</td>
      <td>{{ invoice.due_date.strftime('%d.%m.%Y') if invoice.due_date is defined and invoice.due_date else '-' }}</td>
      <td>{{ "%.2f"|format(invoice.total) }} &euro;</td>
      <td>
        {% if invoice.status == 'paid' %}
          <span class="badge badge-paid">Plne zaplatená</span>
        {% elif invoice.status == 'overdue' %}
          <span class="badge badge-overdue">Po splatnosti</span>
        {% elif invoice.status == 'overpaid' %}
          <span class="badge badge-overpaid">Preplatená</span>
        {% else %}
          <span class="badge badge-unpaid">Čaká platbu</span>
        {% endif %}
      </td>
      <td>
        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
          <button type="button" class="btn btn-sm btn-outline-info"
            data-bs-toggle="modal" data-bs-target="#viewInvoiceModal"
            data-invoice-id="{{ invoice.id }}">Zobraziť</button>
          {% if invoice.is_locked %}
            <span class="badge bg-secondary">Uzamknutá</span>
            {% if "manage_all" in user_permissions %}
            <form method="post" action="{{ url_for('admin.unlock_invoice', invoice_id=invoice.id) }}" class="d-inline">
              <button class="btn btn-sm btn-outline-warning" type="submit">Odomknúť</button>
            </form>
            {% endif %}
          {% elif "manage_all" in user_permissions %}
            <button type="button" class="btn btn-sm btn-outline-primary"
              data-bs-toggle="modal" data-bs-target="#editInvoiceModal"
              data-id="{{ invoice.id }}">Upraviť</button>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('invoices.invoice_pdf', invoice_id=invoice.id) }}">PDF</a>
            <form method="post" action="{{ url_for('invoices.send_invoice', invoice_id=invoice.id) }}" class="d-inline">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Email</button>
            </form>
            {% if invoice.payment_status != 'paid' %}
            <form method="post" action="{{ url_for('invoices.initiate_payment', invoice_id=invoice.id) }}" class="d-inline">
              <button class="btn btn-sm btn-outline-success" type="submit">Platba</button>
            </form>
            {% endif %}
          {% endif %}
          {% if invoice.payment_status == 'paid' %}
            <span class="badge bg-success" style="font-size:10px;">Zaplatené {{ invoice.paid_at.strftime('%d.%m.%Y') if invoice.paid_at else '' }}</span>
          {% elif invoice.payment_status == 'pending' %}
            <span class="badge bg-warning text-dark" style="font-size:10px;">Čaká sa na platbu</span>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('invoices.list_invoices', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
<script>
var _editInvItemIdx = 0;

function addEditInvManualRow() {
  var i = _editInvItemIdx++;
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="manual">' +
    '<input class="form-control form-control-sm" type="text" name="items[' + i + '][description]" placeholder="Popis položky" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="0" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][vat_rate]" value="20"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('editInvItemsBody').insertAdjacentHTML('beforeend', html);
}

function addEditInvItemRow(item) {
  var i = _editInvItemIdx++;
  var typeVal = item.is_manual ? 'manual' : 'delivery';
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="' + typeVal + '">' +
    (item.source_delivery_id ? '<input type="hidden" name="items[' + i + '][source_delivery_id]" value="' + item.source_delivery_id + '">' : '') +
    '<input class="form-control form-control-sm" type="text" name="items[' + i + '][description]" value="' + (item.description || '').replace(/"/g, '&quot;') + '" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="' + item.quantity + '"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + item.unit_price + '" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][vat_rate]" value="' + item.vat_rate + '"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('editInvItemsBody').insertAdjacentHTML('beforeend', html);
}

document.getElementById('viewInvoiceModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var invoiceId = btn ? btn.dataset.invoiceId : null;
  if (!invoiceId) return;
  var modal = this;
  fetch('/invoices/' + invoiceId + '/detail')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      modal.querySelector('#viewInvoiceId').textContent = data.id;
      modal.querySelector('#viewInvoiceNumber').textContent = data.invoice_number || '-';
      modal.querySelector('#viewInvoicePartner').textContent = data.partner_name || '-';
      modal.querySelector('#viewInvoiceStatus').textContent = data.status || '-';
      modal.querySelector('#viewInvoiceTotal').textContent = data.total;
      modal.querySelector('#viewInvoiceTotalVat').textContent = data.total_with_vat;
      var tbody = modal.querySelector('#viewInvoiceItemsBody');
      var tfoot = modal.querySelector('#viewInvoiceItemsFoot');
      tbody.innerHTML = '';
      tfoot.innerHTML = '';
      data.items.forEach(function(item) {
        tbody.insertAdjacentHTML('beforeend',
          '<tr><td>' + item.description + '</td><td>' + item.quantity + '</td><td>' + item.unit_price +
          '</td><td>' + item.vat_rate + '</td><td>' + item.vat_amount + '</td><td>' + item.total_with_vat + '</td></tr>');
      });
      if (data.items.length === 0) {
        tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="6" class="text-muted">Žiadne položky</td></tr>');
      } else {
        tfoot.insertAdjacentHTML('beforeend',
          '<tr class="fw-bold"><td colspan="4">Spolu</td><td></td><td>' + data.total_with_vat + '</td></tr>');
      }
      // Load QR code
      var qrDiv = modal.querySelector('#viewInvoiceQr');
      var qrImg = modal.querySelector('#viewInvoiceQrImg');
      qrDiv.style.display = 'none';
      fetch('/invoices/' + data.id + '/qr')
        .then(function(r) { if (r.ok) return r.blob(); throw new Error('no qr'); })
        .then(function(blob) {
          qrImg.src = URL.createObjectURL(blob);
          qrDiv.style.display = '';
        })
        .catch(function() { qrDiv.style.display = 'none'; });
    });
});
document.getElementById('viewInvoiceModal').addEventListener('hidden.bs.modal', function() {
  this.querySelector('#viewInvoiceItemsBody').innerHTML = '';
  this.querySelector('#viewInvoiceItemsFoot').innerHTML = '';
  this.querySelector('#viewInvoiceQr').style.display = 'none';
});

document.getElementById('editInvoiceModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var invoiceId = btn ? btn.dataset.id : null;
  if (!invoiceId) return;
  var modal = this;
  var form = modal.querySelector('form');
  form.action = '/invoices/' + invoiceId + '/edit';
  _editInvItemIdx = 0;
  fetch('/invoices/' + invoiceId + '/detail')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      form.querySelector('[name="status"]').value = data.status || 'draft';
      var tbody = document.getElementById('editInvItemsBody');
      tbody.innerHTML = '';
      if (data.is_locked) {
        document.getElementById('editInvReadonlyNotice').classList.remove('d-none');
        document.getElementById('editInvItemButtons').style.display = 'none';
        document.getElementById('editInvSaveBtn').disabled = true;
        data.items.forEach(function(item) {
          tbody.insertAdjacentHTML('beforeend',
            '<tr><td>' + item.description + '</td><td>' + item.quantity + '</td><td>' + item.unit_price +
            '</td><td>' + item.vat_rate + '</td><td></td></tr>');
        });
      } else {
        document.getElementById('editInvReadonlyNotice').classList.add('d-none');
        document.getElementById('editInvItemButtons').style.display = '';
        document.getElementById('editInvSaveBtn').disabled = false;
        data.items.forEach(function(item) {
          addEditInvItemRow(item);
        });
      }
    });
});
document.getElementById('editInvoiceModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('editInvItemsBody').innerHTML = '';
  _editInvItemIdx = 0;
});
</script>

{% include "components/add_partner_modal.html" %}

<script>
(function() {
  var searchInput = document.getElementById('invPartnerSearch');
  var hiddenInput = document.getElementById('invPartnerIdHidden');
  var resultsDiv = document.getElementById('invPartnerResults');
  var partnerSelect = document.getElementById('invPartnerSelect');
  if (!searchInput) return;
  var debounceTimer;
  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    var q = searchInput.value.trim();
    if (q.length < 2) { resultsDiv.style.display = 'none'; return; }
    debounceTimer = setTimeout(function() {
      fetch('/partners/search?q=' + encodeURIComponent(q))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          resultsDiv.innerHTML = '';
          if (!data.length) { resultsDiv.innerHTML = '<div class="list-group-item text-muted small">Žiadne výsledky</div>'; }
          data.forEach(function(p) {
            var item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action small';
            item.textContent = p.name + (p.ico ? ' (' + p.ico + ')' : '') + (p.city ? ' — ' + p.city : '');
            item.addEventListener('click', function(e) {
              e.preventDefault();
              searchInput.value = p.name;
              hiddenInput.value = p.id;
              resultsDiv.style.display = 'none';
              // Trigger partner select change to load delivery notes
              if (partnerSelect) { partnerSelect.value = p.id; partnerSelect.dispatchEvent(new Event('change')); }
            });
            resultsDiv.appendChild(item);
          });
          resultsDiv.style.display = '';
        });
    }, 300);
  });
  document.addEventListener('click', function(e) { if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) resultsDiv.style.display = 'none'; });
})();
</script>
{% endblock %}
