{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Faktúry</h4>
  <div>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">+ Vytvoriť faktúru</button>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addManualItemModal">+ Manuálna položka</button>
  </div>
</div>
<div class="modal fade" id="addInvoiceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nová zúčtovacia faktúra</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Partner</label>
              <select class="form-select" name="partner_id" required>
                {% for partner in partners %}
                <option value="{{ partner.id }}">{{ partner.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Vytvoriť zúčtovaciu faktúru</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="addManualItemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="manual-item-form" method="post" data-url-template="{{ url_for('invoices.add_invoice_item', invoice_id=0) }}">
        <div class="modal-header">
          <h5 class="modal-title">Manuálna položka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">ID faktúry</label>
              <input class="form-control" id="manual-invoice-id" name="invoice_id" required>
            </div>
            <div class="col-md-5">
              <label class="form-label">Popis</label>
              <input class="form-control" name="description" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Množstvo</label>
              <input class="form-control" name="quantity" type="number" min="1" value="1" required>
            </div>
            <div class="col-md-2">
              <label class="form-label">Jedn. cena</label>
              <input class="form-control" name="unit_price" type="number" step="0.01" value="0" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Pridať položku</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editInvoiceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editInvoiceForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť faktúru</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Stav</label>
              <select class="form-select" name="status">
                {% for status in valid_invoice_statuses %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
document.getElementById('manual-item-form').addEventListener('submit', function(e) {
  var invoiceId = document.getElementById('manual-invoice-id').value;
  if (invoiceId) {
    this.action = this.dataset.urlTemplate.replace('/0/', '/' + invoiceId + '/');
  }
});
</script>
<table class="table table-striped bg-white shadow-sm">
  <thead>
    <tr class="table-filter">
      <th></th>
      <th><input type="text" class="form-control form-control-sm" data-col="1" placeholder="ID..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="2" placeholder="Partner..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="3" placeholder="Stav..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="4" placeholder="Spolu..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="5" placeholder="Položky..."></th>
      <th></th>
    </tr>
    <tr>
      <th>Akcie</th>
      <th>ID</th>
      <th>Partner</th>
      <th>Stav</th>
      <th>Spolu</th>
      <th>Položky</th>
      <th>Export</th>
    </tr>
  </thead>
  <tbody>
    {% for invoice in invoices %}
    <tr>
      <td class="text-nowrap">
        {% if invoice.is_locked %}
          <span class="badge bg-secondary mb-1">Uzamknutá</span><br>
          {% if "manage_all" in user_permissions %}
          <form method="post" action="{{ url_for('admin.unlock_invoice', invoice_id=invoice.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-warning" type="submit">Odomknúť</button>
          </form>
          {% endif %}
        {% elif "manage_all" in user_permissions %}
          <button type="button" class="btn btn-sm btn-outline-primary"
            data-bs-toggle="modal" data-bs-target="#editInvoiceModal"
            data-id="{{ invoice.id }}"
            data-status="{{ invoice.status or '' }}">Upraviť</button>
          <form method="post" action="{{ url_for('invoices.delete_invoice', invoice_id=invoice.id) }}" class="d-inline"
                onsubmit="return confirm('Naozaj chcete vymazať túto faktúru?')">
            <button class="btn btn-sm btn-outline-danger" type="submit">Vymazať</button>
          </form>
        {% endif %}
      </td>
      <td>{{ invoice.id }}</td>
      <td>{{ invoice.partner.name }}</td>
      <td>{{ invoice.status }}</td>
      <td>{{ "%.2f"|format(invoice.total) }}</td>
      <td>
        <ul class="list-unstyled mb-0">
          {% for item in invoice.items %}
          <li>{{ item.description }} | {{ item.quantity }}x | {{ "%.2f"|format(item.total) }}</li>
          {% endfor %}
        </ul>
      </td>
      <td>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('invoices.invoice_pdf', invoice_id=invoice.id) }}">PDF</a>
        <form method="post" action="{{ url_for('invoices.send_invoice', invoice_id=invoice.id) }}" class="d-inline">
          <button class="btn btn-sm btn-outline-secondary" type="submit">Email</button>
        </form>
        <form method="post" action="{{ url_for('invoices.export_invoice', invoice_id=invoice.id) }}" class="d-inline">
          <button class="btn btn-sm btn-outline-success" type="submit">Superfaktúra</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('invoices.list_invoices', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
<script>
document.getElementById('editInvoiceModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var form = this.querySelector('form');
  form.action = '/invoices/' + btn.dataset.id + '/edit';
  form.querySelector('[name="status"]').value = btn.dataset.status || 'draft';
});
</script>
{% endblock %}
