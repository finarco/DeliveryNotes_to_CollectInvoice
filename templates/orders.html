{% extends "base.html" %}

{% block page_title %}Objednávky{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">Vytvoriť objednávku</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">
{% endblock %}

{% block content %}
<div class="modal fade" id="addOrderModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nová objednávka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Partner</label>
              <select class="form-select" name="partner_id" required>
                {% for partner in partners %}
                <option value="{{ partner.id }}">{{ partner.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Adresa zvozu</label>
              <select class="form-select" name="pickup_address_id">
                <option value="">-- vyberte --</option>
                {% for address in addresses %}
                <option value="{{ address.id }}">
                  {{ address.partner.name }} / {{ address.address_type }}
                  {% if address.related_partner %}({{ address.related_partner.name }}){% endif %}
                  - {{ address.street }} {{ address.street_number }}, {{ address.city }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Adresa doručenia</label>
              <select class="form-select" name="delivery_address_id">
                <option value="">-- vyberte --</option>
                {% for address in addresses %}
                <option value="{{ address.id }}">
                  {{ address.partner.name }} / {{ address.address_type }}
                  {% if address.related_partner %}({{ address.related_partner.name }}){% endif %}
                  - {{ address.street }} {{ address.street_number }}, {{ address.city }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Termín zvozu</label>
              <input type="datetime-local" class="form-control" name="pickup_datetime">
            </div>
            <div class="col-md-3">
              <label class="form-label">Termín doručenia</label>
              <input type="datetime-local" class="form-control" name="delivery_datetime">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob zvozu</label>
              <input class="form-control" name="pickup_method" placeholder="Osobne/kuriér/vlastný zvoz">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob dodania</label>
              <input class="form-control" name="delivery_method" placeholder="Osobný odber/kuriér/rozvoz">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob platby</label>
              <input class="form-control" name="payment_method" placeholder="Bankový prevod/hotovosť">
            </div>
            <div class="col-md-3">
              <label class="form-label">Platobné podmienky</label>
              <input class="form-control" name="payment_terms" placeholder="Splatnosť 14 dní">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="show_prices" {{ "checked" if app_config.show_prices_default }}>
                <label class="form-check-label">Zobraziť ceny</label>
              </div>
            </div>
          </div>
          <hr>
          <h6>Položky</h6>
          <div class="row g-3">
            {% for product in products %}
            <div class="col-md-3">
              <label class="form-label">{{ product.name }}</label>
              <input class="form-control" type="number" name="product_{{ product.id }}" min="0" value="0">
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Vytvoriť objednávku</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editOrderForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť objednávku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Termín zvozu</label>
              <input type="datetime-local" class="form-control" name="pickup_datetime">
            </div>
            <div class="col-md-6">
              <label class="form-label">Termín doručenia</label>
              <input type="datetime-local" class="form-control" name="delivery_datetime">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob zvozu</label>
              <input class="form-control" name="pickup_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob dodania</label>
              <input class="form-control" name="delivery_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob platby</label>
              <input class="form-control" name="payment_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Platobné podmienky</label>
              <input class="form-control" name="payment_terms">
            </div>
            <div class="col-md-6 d-flex align-items-center pt-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="show_prices" id="edit_order_show_prices">
                <label class="form-check-label" for="edit_order_show_prices">Zobraziť ceny</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="viewOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail objednávky</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">ID</dt><dd class="col-sm-8" id="viewOrderId"></dd>
          <dt class="col-sm-4">Partner</dt><dd class="col-sm-8" id="viewOrderPartner"></dd>
          <dt class="col-sm-4">Termín zvozu</dt><dd class="col-sm-8" id="viewOrderPickupDatetime"></dd>
          <dt class="col-sm-4">Spôsob zvozu</dt><dd class="col-sm-8" id="viewOrderPickupMethod"></dd>
          <dt class="col-sm-4">Termín doručenia</dt><dd class="col-sm-8" id="viewOrderDeliveryDatetime"></dd>
          <dt class="col-sm-4">Spôsob dodania</dt><dd class="col-sm-8" id="viewOrderDeliveryMethod"></dd>
          <dt class="col-sm-4">Spôsob platby</dt><dd class="col-sm-8" id="viewOrderPaymentMethod"></dd>
          <dt class="col-sm-4">Platobné podmienky</dt><dd class="col-sm-8" id="viewOrderPaymentTerms"></dd>
          <dt class="col-sm-4">Zobraziť ceny</dt><dd class="col-sm-8" id="viewOrderShowPrices"></dd>
          <dt class="col-sm-4">Stav</dt><dd class="col-sm-8" id="viewOrderStatus"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>

{# Tabs Navigation #}
<div class="orders-tabs">
  <button type="button" class="orders-tab active" data-status="all">Všetky</button>
  <button type="button" class="orders-tab" data-status="pending">Čakajúce</button>
  <button type="button" class="orders-tab" data-status="processing">Spracováva sa</button>
  <button type="button" class="orders-tab" data-status="completed">Dokončené</button>
</div>

{# Kanban Board View #}
<div class="kanban-board-view" style="display: none;">
  <div class="kanban-board">
    {# Pending Column #}
    <div class="kanban-column pending">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">Čakajúce</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'pending')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'pending' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-pending">Čaká</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
              </svg>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              </svg>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    {# Processing Column #}
    <div class="kanban-column processing">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">Spracováva sa</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'processing')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'processing' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-info">V procese</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
              </svg>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              </svg>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    {# Completed Column #}
    <div class="kanban-column completed">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">Dokončené</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'completed')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'completed' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-success">Hotovo</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
              </svg>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <svg class="order-card-date-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
              </svg>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{# Table View #}
<div class="orders-table-view">
<table class="table table-striped bg-white shadow-sm">
  <thead>
    <tr class="table-filter">
      <th></th>
      <th><input type="text" class="form-control form-control-sm" data-col="1" placeholder="ID..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="2" placeholder="Partner..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="3" placeholder="Zvoz..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="4" placeholder="Doručenie..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="5" placeholder="Platba..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="6" placeholder="Ceny..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="7" placeholder="Stav..."></th>
    </tr>
    <tr>
      <th>Akcie</th>
      <th>ID</th>
      <th>Partner</th>
      <th>Zvoz</th>
      <th>Doručenie</th>
      <th>Platba</th>
      <th>Ceny</th>
      <th>Stav</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
    <tr>
      <td class="actions-col">
        <button type="button" class="btn btn-sm btn-outline-info"
          data-bs-toggle="modal" data-bs-target="#viewOrderModal"
          data-order-id="{{ order.id }}"
          data-partner="{{ order.partner.name }}"
          data-pickup-datetime="{{ order.pickup_datetime or '' }}"
          data-pickup-method="{{ order.pickup_method or '' }}"
          data-delivery-datetime="{{ order.delivery_datetime or '' }}"
          data-delivery-method="{{ order.delivery_method or '' }}"
          data-payment-method="{{ order.payment_method or '' }}"
          data-payment-terms="{{ order.payment_terms or '' }}"
          data-show-prices="{{ 1 if order.show_prices else 0 }}"
          data-confirmed="{{ 1 if order.confirmed else 0 }}">Zobraziť</button>
        {% if order.is_locked %}
          <span class="badge bg-secondary mb-1">Uzamknutá</span>
          {% if "manage_all" in user_permissions %}
          <form method="post" action="{{ url_for('admin.unlock_order', order_id=order.id) }}">
            <button class="btn btn-sm btn-outline-warning" type="submit">Odomknúť</button>
          </form>
          {% endif %}
        {% elif order.delivery_note_links %}
          <span class="badge bg-info mb-1">Má dodací list</span>
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-primary"
            data-bs-toggle="modal" data-bs-target="#editOrderModal"
            data-id="{{ order.id }}"
            data-pickup-datetime="{{ order.pickup_datetime.strftime('%Y-%m-%dT%H:%M') if order.pickup_datetime else '' }}"
            data-delivery-datetime="{{ order.delivery_datetime.strftime('%Y-%m-%dT%H:%M') if order.delivery_datetime else '' }}"
            data-pickup-method="{{ order.pickup_method or '' }}"
            data-delivery-method="{{ order.delivery_method or '' }}"
            data-payment-method="{{ order.payment_method or '' }}"
            data-payment-terms="{{ order.payment_terms or '' }}"
            data-show-prices="{{ 1 if order.show_prices else 0 }}">Upraviť</button>
          <form method="post" action="{{ url_for('orders.delete_order', order_id=order.id) }}"
                onsubmit="return confirm('Naozaj chcete vymazať túto objednávku?')">
            <button class="btn btn-sm btn-outline-danger" type="submit">Vymazať</button>
          </form>
        {% endif %}
      </td>
      <td>{{ order.id }}</td>
      <td>{{ order.partner.name }}</td>
      <td>
        {{ order.pickup_address.street if order.pickup_address }} {{ order.pickup_address.street_number if order.pickup_address }}<br>
        {{ order.pickup_datetime }}<br>
        {{ order.pickup_method }}
      </td>
      <td>
        {{ order.delivery_address.street if order.delivery_address }} {{ order.delivery_address.street_number if order.delivery_address }}<br>
        {{ order.delivery_datetime }}<br>
        {{ order.delivery_method }}
      </td>
      <td>{{ order.payment_method }}<br>{{ order.payment_terms }}</td>
      <td>
        {% if current_user and current_user.role != 'customer' and order.show_prices %}
          Áno
        {% else %}
          Nie
        {% endif %}
      </td>
      <td>
        {% if order.confirmed %}
          <span class="badge bg-success">Potvrdená</span>
          <form method="post" action="{{ url_for('orders.unconfirm_order', order_id=order.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-danger" type="submit">Zrušiť potvrdenie</button>
          </form>
        {% else %}
          <span class="badge bg-warning text-dark">Nepotvrdená</span>
          <form method="post" action="{{ url_for('orders.confirm_order', order_id=order.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-primary" type="submit">Potvrdiť</button>
          </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('orders.list_orders', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
<script>
document.getElementById('viewOrderModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  this.querySelector('#viewOrderId').textContent = btn.dataset.orderId || '-';
  this.querySelector('#viewOrderPartner').textContent = btn.dataset.partner || '-';
  this.querySelector('#viewOrderPickupDatetime').textContent = btn.dataset.pickupDatetime || '-';
  this.querySelector('#viewOrderPickupMethod').textContent = btn.dataset.pickupMethod || '-';
  this.querySelector('#viewOrderDeliveryDatetime').textContent = btn.dataset.deliveryDatetime || '-';
  this.querySelector('#viewOrderDeliveryMethod').textContent = btn.dataset.deliveryMethod || '-';
  this.querySelector('#viewOrderPaymentMethod').textContent = btn.dataset.paymentMethod || '-';
  this.querySelector('#viewOrderPaymentTerms').textContent = btn.dataset.paymentTerms || '-';
  this.querySelector('#viewOrderShowPrices').textContent = btn.dataset.showPrices === '1' ? 'Áno' : 'Nie';
  this.querySelector('#viewOrderStatus').textContent = btn.dataset.confirmed === '1' ? 'Potvrdená' : 'Nepotvrdená';
});
document.getElementById('editOrderModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var form = this.querySelector('form');
  form.action = '/orders/' + btn.dataset.id + '/edit';
  form.querySelector('[name="pickup_datetime"]').value = btn.dataset.pickupDatetime || '';
  form.querySelector('[name="delivery_datetime"]').value = btn.dataset.deliveryDatetime || '';
  form.querySelector('[name="pickup_method"]').value = btn.dataset.pickupMethod || '';
  form.querySelector('[name="delivery_method"]').value = btn.dataset.deliveryMethod || '';
  form.querySelector('[name="payment_method"]').value = btn.dataset.paymentMethod || '';
  form.querySelector('[name="payment_terms"]').value = btn.dataset.paymentTerms || '';
  form.querySelector('[name="show_prices"]').checked = btn.dataset.showPrices === '1';
});

// Tabs functionality
document.querySelectorAll('.orders-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const status = this.dataset.status;

    // Update active state
    document.querySelectorAll('.orders-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');

    // Toggle views based on status
    const kanbanView = document.querySelector('.kanban-board-view');
    const tableView = document.querySelector('.orders-table-view');

    if (status === 'all') {
      // Show table for "all"
      kanbanView.style.display = 'none';
      tableView.style.display = 'block';
    } else {
      // Show kanban for filtered views
      kanbanView.style.display = 'block';
      tableView.style.display = 'none';

      // Filter columns based on status
      document.querySelectorAll('.kanban-column').forEach(col => {
        col.style.display = 'block';
      });

      if (status !== 'all') {
        document.querySelectorAll('.kanban-column').forEach(col => {
          if (!col.classList.contains(status)) {
            col.style.display = 'none';
          }
        });
      }
    }

    localStorage.setItem('ordersView', status);
  });
});

// Restore saved tab
const savedView = localStorage.getItem('ordersView') || 'all';
const savedTab = document.querySelector(`.orders-tab[data-status="${savedView}"]`);
if (savedTab) {
  savedTab.click();
}

// Show order detail function (for card clicks)
function showOrderDetail(orderId) {
  // Find the corresponding row in the table and trigger its view button
  const viewBtn = document.querySelector(`button[data-id="${orderId}"][data-bs-target="#viewOrderModal"]`);
  if (viewBtn) {
    viewBtn.click();
  }
}
</script>

</div>{# End orders-table-view #}

{% endblock %}
