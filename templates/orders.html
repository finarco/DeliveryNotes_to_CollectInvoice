{% extends "base.html" %}

{% block page_title %}Objednávky{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">Vytvoriť objednávku</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/orders.css') }}">
{% endblock %}

{% block content %}
<div class="modal fade" id="addOrderModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nová objednávka</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Partner</label>
              <select class="form-select" name="partner_id" required>
                {% for partner in partners %}
                <option value="{{ partner.id }}">{{ partner.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Adresa zvozu</label>
              <select class="form-select" name="pickup_address_id" id="pickup_address_id">
                <option value="">-- najprv vyberte partnera --</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Adresa doručenia</label>
              <select class="form-select" name="delivery_address_id" id="delivery_address_id">
                <option value="">-- najprv vyberte partnera --</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Termín zvozu</label>
              <input type="datetime-local" class="form-control" name="pickup_datetime">
            </div>
            <div class="col-md-3">
              <label class="form-label">Termín doručenia</label>
              <input type="datetime-local" class="form-control" name="delivery_datetime">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob zvozu</label>
              <input class="form-control" name="pickup_method" placeholder="Osobne/kuriér/vlastný zvoz">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob dodania</label>
              <input class="form-control" name="delivery_method" placeholder="Osobný odber/kuriér/rozvoz">
            </div>
            <div class="col-md-3">
              <label class="form-label">Spôsob platby</label>
              <input class="form-control" name="payment_method" placeholder="Bankový prevod/hotovosť">
            </div>
            <div class="col-md-3">
              <label class="form-label">Platobné podmienky</label>
              <input class="form-control" name="payment_terms" placeholder="Splatnosť 14 dní">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="show_prices" {{ "checked" if app_config.show_prices_default }}>
                <label class="form-check-label">Zobraziť ceny</label>
              </div>
            </div>
          </div>
          <hr>
          <h6>Položky</h6>
          <table class="table table-sm" id="orderItemsTable">
            <thead>
              <tr>
                <th>Typ</th>
                <th>Produkt / Kombinácia / Názov</th>
                <th style="width:100px">Množstvo</th>
                <th style="width:120px">Jedn. cena</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody id="orderItemsBody">
              <!-- rows added dynamically by JS -->
            </tbody>
          </table>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProductRow()">+ Produkt</button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBundleRow()">+ Kombinácia</button>
            {% if "manage_all" in user_permissions or "manage_orders" in user_permissions %}
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addManualRow()">+ Manuálna položka</button>
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Vytvoriť objednávku</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editOrderModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <form id="editOrderForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť objednávku</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Termín zvozu</label>
              <input type="datetime-local" class="form-control" name="pickup_datetime">
            </div>
            <div class="col-md-6">
              <label class="form-label">Termín doručenia</label>
              <input type="datetime-local" class="form-control" name="delivery_datetime">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob zvozu</label>
              <input class="form-control" name="pickup_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob dodania</label>
              <input class="form-control" name="delivery_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Spôsob platby</label>
              <input class="form-control" name="payment_method">
            </div>
            <div class="col-md-6">
              <label class="form-label">Platobné podmienky</label>
              <input class="form-control" name="payment_terms">
            </div>
            <div class="col-md-6 d-flex align-items-center pt-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="show_prices" id="edit_order_show_prices">
                <label class="form-check-label" for="edit_order_show_prices">Zobraziť ceny</label>
              </div>
            </div>
          </div>
          <hr>
          <h6>Položky</h6>
          <div id="editOrderReadonlyNotice" class="alert alert-warning d-none">Objednávka je uzamknutá alebo má dodací list — položky nie je možné upraviť.</div>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Typ</th>
                <th>Produkt / Kombinácia / Názov</th>
                <th style="width:100px">Množstvo</th>
                <th style="width:120px">Jedn. cena</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody id="editOrderItemsBody"></tbody>
          </table>
          <div id="editOrderItemButtons" class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditOrderProductRow()">+ Produkt</button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEditOrderBundleRow()">+ Kombinácia</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addEditOrderManualRow()">+ Manuálna položka</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary" id="editOrderSaveBtn">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="viewOrderModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail objednávky</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-3">
          <dt class="col-sm-4">ID</dt><dd class="col-sm-8" id="viewOrderId"></dd>
          <dt class="col-sm-4">Partner</dt><dd class="col-sm-8" id="viewOrderPartner"></dd>
          <dt class="col-sm-4">Termín zvozu</dt><dd class="col-sm-8" id="viewOrderPickupDatetime"></dd>
          <dt class="col-sm-4">Spôsob zvozu</dt><dd class="col-sm-8" id="viewOrderPickupMethod"></dd>
          <dt class="col-sm-4">Termín doručenia</dt><dd class="col-sm-8" id="viewOrderDeliveryDatetime"></dd>
          <dt class="col-sm-4">Spôsob dodania</dt><dd class="col-sm-8" id="viewOrderDeliveryMethod"></dd>
          <dt class="col-sm-4">Spôsob platby</dt><dd class="col-sm-8" id="viewOrderPaymentMethod"></dd>
          <dt class="col-sm-4">Platobné podmienky</dt><dd class="col-sm-8" id="viewOrderPaymentTerms"></dd>
          <dt class="col-sm-4">Zobraziť ceny</dt><dd class="col-sm-8" id="viewOrderShowPrices"></dd>
          <dt class="col-sm-4">Stav</dt><dd class="col-sm-8" id="viewOrderStatus"></dd>
        </dl>
        <h6>Položky</h6>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Typ</th>
              <th>Produkt / Názov</th>
              <th>Množstvo</th>
              <th>Jedn. cena</th>
            </tr>
          </thead>
          <tbody id="viewOrderItemsBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>

{# Tabs Navigation #}
<div class="orders-tabs">
  <button type="button" class="orders-tab active" data-status="all">Všetky</button>
  <button type="button" class="orders-tab" data-status="pending">Čakajúce</button>
  <button type="button" class="orders-tab" data-status="processing">Spracováva sa</button>
  <button type="button" class="orders-tab" data-status="completed">Dokončené</button>
</div>

{# Kanban Board View #}
<div class="kanban-board-view" style="display: none;">
  <div class="kanban-board">
    {# Pending Column #}
    <div class="kanban-column pending">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">Nové</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'pending')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'pending' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-pending">Čaká</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="calendar-check" class="order-card-date-icon"></i>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="truck" class="order-card-date-icon"></i>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    {# Processing Column #}
    <div class="kanban-column processing">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">V procese</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'processing')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'processing' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-info">V procese</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="calendar-check" class="order-card-date-icon"></i>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="truck" class="order-card-date-icon"></i>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>

    {# Completed Column #}
    <div class="kanban-column completed">
      <div class="kanban-column-header">
        <h3 class="kanban-column-title">Dokončené</h3>
        <span class="kanban-column-count">
          {{ orders|selectattr('status', 'equalto', 'completed')|list|length }}
        </span>
      </div>
      <div class="kanban-cards">
        {% for order in orders %}
        {% if order.status == 'completed' %}
        <div class="order-card" onclick="showOrderDetail({{ order.id }})">
          <div class="order-card-header">
            <span class="order-card-id">#{{ order.id }}</span>
            <span class="badge badge-success">Hotovo</span>
          </div>
          <div class="order-card-partner">{{ order.partner.name if order.partner else '-' }}</div>
          <div class="order-card-dates">
            {% if order.pickup_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="calendar-check" class="order-card-date-icon"></i>
              <span>Zvoz: {{ order.pickup_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if order.delivery_datetime %}
            <div class="order-card-date-row">
              <i data-lucide="truck" class="order-card-date-icon"></i>
              <span>Dodanie: {{ order.delivery_datetime.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
            {% endif %}
          </div>
          <div class="order-card-divider"></div>
          <div class="order-card-footer">
            <span class="order-card-items">{{ order.items|length }} položiek</span>
            <span class="order-card-price">{{ "%.2f"|format(order.total_price or 0) }} €</span>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{# Table View #}
<div class="orders-table-view">
<table class="table table-striped bg-white shadow-sm">
  <thead>
    <tr class="table-filter">
      <th></th>
      <th><input type="text" class="form-control form-control-sm" data-col="1" placeholder="ID..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="2" placeholder="Partner..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="3" placeholder="Zvoz..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="4" placeholder="Doručenie..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="5" placeholder="Platba..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="6" placeholder="Ceny..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="7" placeholder="Stav..."></th>
    </tr>
    <tr>
      <th>Akcie</th>
      <th>ID</th>
      <th>Partner</th>
      <th>Zvoz</th>
      <th>Doručenie</th>
      <th>Platba</th>
      <th>Ceny</th>
      <th>Stav</th>
    </tr>
  </thead>
  <tbody>
    {% for order in orders %}
    <tr>
      <td class="actions-col">
        <button type="button" class="btn btn-sm btn-outline-info"
          data-bs-toggle="modal" data-bs-target="#viewOrderModal"
          data-order-id="{{ order.id }}">Zobraziť</button>
        {% if order.is_locked %}
          <span class="badge bg-secondary mb-1">Uzamknutá</span>
          {% if "manage_all" in user_permissions %}
          <form method="post" action="{{ url_for('admin.unlock_order', order_id=order.id) }}">
            <button class="btn btn-sm btn-outline-warning" type="submit">Odomknúť</button>
          </form>
          {% endif %}
        {% elif order.delivery_note_links %}
          <span class="badge bg-info mb-1">Má dodací list</span>
        {% else %}
          <button type="button" class="btn btn-sm btn-outline-primary"
            data-bs-toggle="modal" data-bs-target="#editOrderModal"
            data-id="{{ order.id }}">Upraviť</button>
          <form method="post" action="{{ url_for('orders.delete_order', order_id=order.id) }}"
                onsubmit="return confirm('Naozaj chcete vymazať túto objednávku?')">
            <button class="btn btn-sm btn-outline-danger" type="submit">Vymazať</button>
          </form>
        {% endif %}
      </td>
      <td>{{ order.id }}</td>
      <td>{{ order.partner.name }}</td>
      <td>
        {{ order.pickup_address.street if order.pickup_address }} {{ order.pickup_address.street_number if order.pickup_address }}<br>
        {{ order.pickup_datetime }}<br>
        {{ order.pickup_method }}
      </td>
      <td>
        {{ order.delivery_address.street if order.delivery_address }} {{ order.delivery_address.street_number if order.delivery_address }}<br>
        {{ order.delivery_datetime }}<br>
        {{ order.delivery_method }}
      </td>
      <td>{{ order.payment_method }}<br>{{ order.payment_terms }}</td>
      <td>
        {% if current_user and current_user.role != 'customer' and order.show_prices %}
          Áno
        {% else %}
          Nie
        {% endif %}
      </td>
      <td>
        {% if order.confirmed %}
          <span class="badge bg-success">Potvrdená</span>
          <form method="post" action="{{ url_for('orders.unconfirm_order', order_id=order.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-danger" type="submit">Zrušiť potvrdenie</button>
          </form>
        {% else %}
          <span class="badge bg-warning text-dark">Nepotvrdená</span>
          <form method="post" action="{{ url_for('orders.confirm_order', order_id=order.id) }}" class="d-inline">
            <button class="btn btn-sm btn-outline-primary" type="submit">Potvrdiť</button>
          </form>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('orders.list_orders', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
<script>
// -- Product/Bundle data for dynamic item rows --
var PRODUCTS = [
  {% for p in products %}
  { id: {{ p.id }}, name: {{ p.name|tojson }}, price: "{{ p.price }}" }{{ "," if not loop.last }}
  {% endfor %}
];
var BUNDLES = [
  {% for b in bundles %}
  { id: {{ b.id }}, name: {{ b.name|tojson }}, price: "{{ b.bundle_price }}" }{{ "," if not loop.last }}
  {% endfor %}
];
var _itemIdx = 0;

// -- Address filtering --
var partnerSelect = document.querySelector('#addOrderModal select[name="partner_id"]');
function loadPartnerAddresses() {
  var pid = partnerSelect.value;
  if (!pid) return;
  fetch('/orders/partner-addresses/' + pid)
    .then(function(r) { return r.json(); })
    .then(function(addrs) {
      ['pickup_address_id', 'delivery_address_id'].forEach(function(selId) {
        var sel = document.getElementById(selId);
        sel.innerHTML = '<option value="">-- vyberte --</option>';
        addrs.forEach(function(a) {
          var opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.label;
          sel.appendChild(opt);
        });
      });
    });
}
if (partnerSelect) {
  partnerSelect.addEventListener('change', loadPartnerAddresses);
}
document.getElementById('addOrderModal').addEventListener('show.bs.modal', function() {
  if (partnerSelect && partnerSelect.value) {
    loadPartnerAddresses();
  }
});

// -- Dynamic item rows --
function addProductRow() {
  var i = _itemIdx++;
  var opts = PRODUCTS.map(function(p) {
    return '<option value="' + p.id + '" data-price="' + p.price + '">' + p.name + '</option>';
  }).join('');
  var defaultPrice = PRODUCTS.length ? PRODUCTS[0].price : '0';
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="product">Produkt</td>' +
    '<td><select class="form-select form-select-sm" name="items[' + i + '][product_id]" onchange="onProductChange(this,' + i + ')">' + opts + '</select></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + defaultPrice + '"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('orderItemsBody').insertAdjacentHTML('beforeend', html);
}

function addBundleRow() {
  var i = _itemIdx++;
  var opts = BUNDLES.map(function(b) {
    return '<option value="' + b.id + '" data-price="' + b.price + '">' + b.name + '</option>';
  }).join('');
  var defaultPrice = BUNDLES.length ? BUNDLES[0].price : '0';
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="bundle">Kombinácia</td>' +
    '<td><select class="form-select form-select-sm" name="items[' + i + '][bundle_id]" onchange="onBundleChange(this,' + i + ')">' + opts + '</select></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + defaultPrice + '"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('orderItemsBody').insertAdjacentHTML('beforeend', html);
}

function addManualRow() {
  var i = _itemIdx++;
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="manual">Manuálna</td>' +
    '<td><input class="form-control form-control-sm" type="text" name="items[' + i + '][manual_name]" placeholder="Názov položky" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="0" required></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('orderItemsBody').insertAdjacentHTML('beforeend', html);
}

function onProductChange(sel, idx) {
  var opt = sel.options[sel.selectedIndex];
  var price = opt ? opt.dataset.price : '0';
  var row = sel.closest('tr');
  row.querySelector('input[name="items[' + idx + '][unit_price]"]').value = price;
}

function onBundleChange(sel, idx) {
  var opt = sel.options[sel.selectedIndex];
  var price = opt ? opt.dataset.price : '0';
  var row = sel.closest('tr');
  row.querySelector('input[name="items[' + idx + '][unit_price]"]').value = price;
}

var _editOrderItemIdx = 0;

function addEditOrderProductRow() {
  var i = _editOrderItemIdx++;
  var opts = PRODUCTS.map(function(p) {
    return '<option value="' + p.id + '" data-price="' + p.price + '">' + p.name + '</option>';
  }).join('');
  var defaultPrice = PRODUCTS.length ? PRODUCTS[0].price : '0';
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="product">Produkt</td>' +
    '<td><select class="form-select form-select-sm" name="items[' + i + '][product_id]" onchange="onEditOrderProductChange(this,' + i + ')">' + opts + '</select></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + defaultPrice + '"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('editOrderItemsBody').insertAdjacentHTML('beforeend', html);
}

function addEditOrderBundleRow() {
  var i = _editOrderItemIdx++;
  var opts = BUNDLES.map(function(b) {
    return '<option value="' + b.id + '" data-price="' + b.price + '">' + b.name + '</option>';
  }).join('');
  var defaultPrice = BUNDLES.length ? BUNDLES[0].price : '0';
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="bundle">Kombinácia</td>' +
    '<td><select class="form-select form-select-sm" name="items[' + i + '][bundle_id]" onchange="onEditOrderBundleChange(this,' + i + ')">' + opts + '</select></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + defaultPrice + '"></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('editOrderItemsBody').insertAdjacentHTML('beforeend', html);
}

function addEditOrderManualRow() {
  var i = _editOrderItemIdx++;
  var html = '<tr>' +
    '<td><input type="hidden" name="items[' + i + '][type]" value="manual">Manuálna</td>' +
    '<td><input class="form-control form-control-sm" type="text" name="items[' + i + '][manual_name]" placeholder="Názov položky" required></td>' +
    '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="1"></td>' +
    '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="0" required></td>' +
    '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
    '</tr>';
  document.getElementById('editOrderItemsBody').insertAdjacentHTML('beforeend', html);
}

function addEditOrderItemRow(item) {
  var i = _editOrderItemIdx++;
  var html = '';
  if (item.type === 'product') {
    var opts = PRODUCTS.map(function(p) {
      var sel = p.id === item.product_id ? ' selected' : '';
      return '<option value="' + p.id + '" data-price="' + p.price + '"' + sel + '>' + p.name + '</option>';
    }).join('');
    html = '<tr>' +
      '<td><input type="hidden" name="items[' + i + '][type]" value="product">Produkt</td>' +
      '<td><select class="form-select form-select-sm" name="items[' + i + '][product_id]" onchange="onEditOrderProductChange(this,' + i + ')">' + opts + '</select></td>' +
      '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="' + item.quantity + '"></td>' +
      '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + item.unit_price + '"></td>' +
      '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
      '</tr>';
  } else if (item.type === 'bundle') {
    var opts = BUNDLES.map(function(b) {
      var sel = b.id === item.bundle_id ? ' selected' : '';
      return '<option value="' + b.id + '" data-price="' + b.price + '"' + sel + '>' + b.name + '</option>';
    }).join('');
    html = '<tr>' +
      '<td><input type="hidden" name="items[' + i + '][type]" value="bundle">Kombinácia</td>' +
      '<td><select class="form-select form-select-sm" name="items[' + i + '][bundle_id]" onchange="onEditOrderBundleChange(this,' + i + ')">' + opts + '</select></td>' +
      '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="' + item.quantity + '"></td>' +
      '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + item.unit_price + '"></td>' +
      '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
      '</tr>';
  } else {
    html = '<tr>' +
      '<td><input type="hidden" name="items[' + i + '][type]" value="manual">Manuálna</td>' +
      '<td><input class="form-control form-control-sm" type="text" name="items[' + i + '][manual_name]" value="' + (item.manual_name || '').replace(/"/g, '&quot;') + '" required></td>' +
      '<td><input class="form-control form-control-sm" type="number" name="items[' + i + '][quantity]" min="1" value="' + item.quantity + '"></td>' +
      '<td><input class="form-control form-control-sm" type="number" step="0.01" name="items[' + i + '][unit_price]" value="' + item.unit_price + '" required></td>' +
      '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>' +
      '</tr>';
  }
  document.getElementById('editOrderItemsBody').insertAdjacentHTML('beforeend', html);
}

function onEditOrderProductChange(sel, idx) {
  var opt = sel.options[sel.selectedIndex];
  sel.closest('tr').querySelector('input[name="items[' + idx + '][unit_price]"]').value = opt ? opt.dataset.price : '0';
}
function onEditOrderBundleChange(sel, idx) {
  var opt = sel.options[sel.selectedIndex];
  sel.closest('tr').querySelector('input[name="items[' + idx + '][unit_price]"]').value = opt ? opt.dataset.price : '0';
}

document.getElementById('viewOrderModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var orderId = btn ? btn.dataset.orderId : null;
  if (!orderId) return;
  var modal = this;
  fetch('/orders/' + orderId + '/detail')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      modal.querySelector('#viewOrderId').textContent = data.id;
      modal.querySelector('#viewOrderPartner').textContent = data.partner_name || '-';
      modal.querySelector('#viewOrderPickupDatetime').textContent = data.pickup_datetime || '-';
      modal.querySelector('#viewOrderPickupMethod').textContent = data.pickup_method || '-';
      modal.querySelector('#viewOrderDeliveryDatetime').textContent = data.delivery_datetime || '-';
      modal.querySelector('#viewOrderDeliveryMethod').textContent = data.delivery_method || '-';
      modal.querySelector('#viewOrderPaymentMethod').textContent = data.payment_method || '-';
      modal.querySelector('#viewOrderPaymentTerms').textContent = data.payment_terms || '-';
      modal.querySelector('#viewOrderShowPrices').textContent = data.show_prices ? 'Áno' : 'Nie';
      modal.querySelector('#viewOrderStatus').textContent = data.confirmed ? 'Potvrdená' : 'Nepotvrdená';
      var tbody = modal.querySelector('#viewOrderItemsBody');
      tbody.innerHTML = '';
      data.items.forEach(function(item) {
        var typeLabel = item.type === 'product' ? 'Produkt' : (item.type === 'bundle' ? 'Kombinácia' : 'Manuálna');
        tbody.insertAdjacentHTML('beforeend',
          '<tr><td>' + typeLabel + '</td><td>' + item.name + '</td><td>' + item.quantity + '</td><td>' + item.unit_price + '</td></tr>');
      });
      if (data.items.length === 0) {
        tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="4" class="text-muted">Žiadne položky</td></tr>');
      }
    });
});
document.getElementById('viewOrderModal').addEventListener('hidden.bs.modal', function() {
  this.querySelector('#viewOrderItemsBody').innerHTML = '';
});

document.getElementById('editOrderModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var orderId = btn ? btn.dataset.id : null;
  if (!orderId) return;
  var modal = this;
  var form = modal.querySelector('form');
  form.action = '/orders/' + orderId + '/edit';
  _editOrderItemIdx = 0;
  fetch('/orders/' + orderId + '/detail')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      form.querySelector('[name="pickup_datetime"]').value = data.pickup_datetime || '';
      form.querySelector('[name="delivery_datetime"]').value = data.delivery_datetime || '';
      form.querySelector('[name="pickup_method"]').value = data.pickup_method || '';
      form.querySelector('[name="delivery_method"]').value = data.delivery_method || '';
      form.querySelector('[name="payment_method"]').value = data.payment_method || '';
      form.querySelector('[name="payment_terms"]').value = data.payment_terms || '';
      form.querySelector('[name="show_prices"]').checked = data.show_prices;
      var tbody = document.getElementById('editOrderItemsBody');
      tbody.innerHTML = '';
      var readonly = data.is_locked || data.has_delivery_notes;
      if (readonly) {
        document.getElementById('editOrderReadonlyNotice').classList.remove('d-none');
        document.getElementById('editOrderItemButtons').style.display = 'none';
        document.getElementById('editOrderSaveBtn').disabled = true;
        data.items.forEach(function(item) {
          var typeLabel = item.type === 'product' ? 'Produkt' : (item.type === 'bundle' ? 'Kombinácia' : 'Manuálna');
          tbody.insertAdjacentHTML('beforeend',
            '<tr><td>' + typeLabel + '</td><td>' + item.name + '</td><td>' + item.quantity + '</td><td>' + item.unit_price + '</td><td></td></tr>');
        });
      } else {
        document.getElementById('editOrderReadonlyNotice').classList.add('d-none');
        document.getElementById('editOrderItemButtons').style.display = '';
        document.getElementById('editOrderSaveBtn').disabled = false;
        data.items.forEach(function(item) {
          addEditOrderItemRow(item);
        });
      }
    });
});
document.getElementById('editOrderModal').addEventListener('hidden.bs.modal', function() {
  document.getElementById('editOrderItemsBody').innerHTML = '';
  _editOrderItemIdx = 0;
});

// Tabs functionality
document.querySelectorAll('.orders-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    const status = this.dataset.status;

    // Update active state
    document.querySelectorAll('.orders-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');

    // Toggle views based on status
    const kanbanView = document.querySelector('.kanban-board-view');
    const tableView = document.querySelector('.orders-table-view');

    if (status === 'all') {
      // Show table for "all"
      kanbanView.style.display = 'none';
      tableView.style.display = 'block';
    } else {
      // Show kanban for filtered views
      kanbanView.style.display = 'block';
      tableView.style.display = 'none';

      // Filter columns based on status
      document.querySelectorAll('.kanban-column').forEach(col => {
        col.style.display = 'block';
      });

      if (status !== 'all') {
        document.querySelectorAll('.kanban-column').forEach(col => {
          if (!col.classList.contains(status)) {
            col.style.display = 'none';
          }
        });
      }
    }

    localStorage.setItem('ordersView', status);
  });
});

// Restore saved tab
const savedView = localStorage.getItem('ordersView') || 'all';
const savedTab = document.querySelector(`.orders-tab[data-status="${savedView}"]`);
if (savedTab) {
  savedTab.click();
}

// Show order detail function (for card clicks)
function showOrderDetail(orderId) {
  var viewBtn = document.querySelector('button[data-order-id="' + orderId + '"][data-bs-target="#viewOrderModal"]');
  if (viewBtn) {
    viewBtn.click();
  }
}
</script>

</div>{# End orders-table-view #}

{% endblock %}
