{% extends "base.html" %}
{% block title %}Predplatné{% endblock %}
{% block content %}
<div class="content-area">
  <div class="page-header">
    <h1>Predplatné</h1>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if subscription %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Aktuálny plán: {{ plan.name if plan else 'N/A' }}</h5>
      <p>
        <span class="badge {% if subscription.status == 'active' %}bg-success{% elif subscription.status == 'trial' %}bg-info{% elif subscription.status == 'suspended' %}bg-danger{% else %}bg-warning{% endif %}">
          {{ subscription.status|upper }}
        </span>
      </p>
      {% if subscription.status == 'trial' and subscription.trial_ends_at %}
        <p>Skúšobné obdobie končí: {{ subscription.trial_ends_at.strftime('%d.%m.%Y') }}</p>
      {% endif %}
      {% if subscription.current_period_end %}
        <p>Fakturačné obdobie do: {{ subscription.current_period_end.strftime('%d.%m.%Y') }}</p>
      {% endif %}
      <p>Fakturačný cyklus: {{ 'Ročný' if subscription.billing_cycle == 'yearly' else 'Mesačný' }}</p>

      {% if subscription.status not in ('cancelled',) %}
      <form method="post" action="{{ url_for('billing.cancel') }}" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Naozaj chcete zrušiť predplatné?')">
          Zrušiť predplatné
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <h4>Dostupné plány</h4>
  <div class="row g-3 mb-4">
    {% for p in plans %}
    <div class="col-md-4">
      <div class="card {% if plan and plan.id == p.id %}border-primary{% endif %}">
        <div class="card-body text-center">
          <h5>{{ p.name }}</h5>
          <p class="text-muted">{{ p.description }}</p>
          <h3>{{ p.price_monthly }} EUR<small>/mesiac</small></h3>
          <p class="small text-muted">alebo {{ p.price_yearly }} EUR/rok</p>
          <ul class="list-unstyled small">
            <li>{{ 'Neobmedzený' if p.max_users == 0 else p.max_users }} používateľov</li>
            <li>{{ 'Neobmedzený' if p.max_partners == 0 else p.max_partners }} partnerov</li>
            <li>{{ 'Neobmedzený' if p.max_invoices_per_month == 0 else p.max_invoices_per_month }} faktúr/mesiac</li>
          </ul>
          {% if not plan or plan.id != p.id %}
          <form method="post" action="{{ url_for('billing.subscribe') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="plan_id" value="{{ p.id }}">
            <input type="hidden" name="billing_cycle" value="monthly">
            <button type="submit" class="btn btn-primary btn-sm">Vybrať plán</button>
          </form>
          {% else %}
          <span class="badge bg-primary">Aktuálny plán</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if payments %}
  <h4>Posledné platby</h4>
  <table class="table table-sm">
    <thead><tr><th>Dátum</th><th>Suma</th><th>Metóda</th><th>Stav</th></tr></thead>
    <tbody>
    {% for pay in payments %}
    <tr>
      <td>{{ pay.created_at.strftime('%d.%m.%Y') if pay.created_at else '-' }}</td>
      <td>{{ pay.amount }} {{ pay.currency }}</td>
      <td>{{ pay.payment_method }}</td>
      <td>
        <span class="badge {% if pay.status == 'completed' %}bg-success{% elif pay.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
          {{ pay.status }}
        </span>
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>
{% endblock %}
