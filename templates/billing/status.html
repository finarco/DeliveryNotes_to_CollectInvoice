{% extends "base.html" %}

{% block page_title %}Predplatne{% endblock %}

{% block content %}
  {% if subscription %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Aktualny plan: {{ plan.name if plan else 'N/A' }}</h5>
      <p>
        <span class="badge {% if subscription.status == 'active' %}bg-success{% elif subscription.status == 'trial' %}bg-info{% elif subscription.status == 'suspended' %}bg-danger{% elif subscription.status == 'pending_payment' %}bg-warning{% else %}bg-warning{% endif %}">
          {{ subscription.status|upper }}
        </span>
      </p>
      {% if subscription.status == 'trial' and subscription.trial_ends_at %}
        <p>Skusobne obdobie konci: {{ subscription.trial_ends_at.strftime('%d.%m.%Y') }}</p>
      {% endif %}
      {% if subscription.current_period_end %}
        <p>Fakturacne obdobie do: {{ subscription.current_period_end.strftime('%d.%m.%Y') }}</p>
      {% endif %}
      <p>Fakturacny cyklus: {{ 'Rocny' if subscription.billing_cycle == 'yearly' else 'Mesacny' }}</p>

      {% if pending_payment %}
      <div class="alert alert-warning mt-3">
        <strong>Nedokoncena platba</strong> â€” mate rozpracovanu platbu vo vyske {{ pending_payment.amount }} {{ pending_payment.currency }}.
        <a href="{{ url_for('billing.payment_page', payment_id=pending_payment.id) }}" class="btn btn-warning btn-sm ms-2">
          <i data-lucide="credit-card"></i> Dokoncit platbu
        </a>
      </div>
      {% endif %}

      {% if subscription.status not in ('cancelled',) %}
      <form method="post" action="{{ url_for('billing.cancel') }}" class="mt-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Naozaj chcete zrusit predplatne?')">
          Zrusit predplatne
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <h4>Dostupne plany</h4>
  <div class="row g-3 mb-4">
    {% for p in plans %}
    <div class="col-md-4">
      <div class="card {% if plan and plan.id == p.id %}border-primary{% endif %}">
        <div class="card-body text-center">
          <h5>{{ p.name }}</h5>
          <p class="text-muted">{{ p.description }}</p>
          <h3>{{ p.price_monthly }} EUR<small>/mesiac</small></h3>
          <p class="small text-muted">alebo {{ p.price_yearly }} EUR/rok</p>
          <ul class="list-unstyled small">
            <li>{{ 'Neobmedzeny' if p.max_users == 0 else p.max_users }} pouzivatelov</li>
            <li>{{ 'Neobmedzeny' if p.max_partners == 0 else p.max_partners }} partnerov</li>
            <li>{{ 'Neobmedzeny' if p.max_invoices_per_month == 0 else p.max_invoices_per_month }} faktur/mesiac</li>
          </ul>
          {% if not plan or plan.id != p.id %}
          <form method="post" action="{{ url_for('billing.subscribe') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="plan_id" value="{{ p.id }}">
            <div class="mb-2">
              <select name="billing_cycle" class="form-select form-select-sm">
                <option value="monthly">Mesacne ({{ p.price_monthly }} EUR)</option>
                <option value="yearly">Rocne ({{ p.price_yearly }} EUR)</option>
              </select>
            </div>
            {% if p.price_monthly == 0 and p.price_yearly == 0 %}
              <button type="submit" class="btn btn-primary btn-sm">Vybrat plan</button>
            {% else %}
              <button type="submit" class="btn btn-primary btn-sm">
                <i data-lucide="credit-card"></i> Vybrat a zaplatit
              </button>
            {% endif %}
          </form>
          {% else %}
          <span class="badge bg-primary">Aktualny plan</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if payments %}
  <h4>Posledne platby</h4>
  <table class="table table-sm">
    <thead><tr><th>Datum</th><th>Suma</th><th>Metoda</th><th>Stav</th><th></th></tr></thead>
    <tbody>
    {% for pay in payments %}
    <tr>
      <td>{{ pay.created_at.strftime('%d.%m.%Y') if pay.created_at else '-' }}</td>
      <td>{{ pay.amount }} {{ pay.currency }}</td>
      <td>{{ pay.payment_method }}</td>
      <td>
        <span class="badge {% if pay.status == 'completed' %}bg-success{% elif pay.status == 'failed' %}bg-danger{% elif pay.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
          {{ pay.status }}
        </span>
      </td>
      <td>
        {% if pay.status == 'pending' and pay.gopay_payment_id %}
          <a href="{{ url_for('billing.payment_page', payment_id=pay.id) }}" class="btn btn-outline-primary btn-sm">
            Zaplatit
          </a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  {% endif %}
{% endblock %}
