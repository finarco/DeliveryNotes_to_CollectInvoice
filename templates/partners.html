{% extends "base.html" %}

{% block page_title %}Partneri{% endblock %}

{% block page_actions %}
<div style="display: flex; gap: 12px; align-items: center;">
  <div class="view-toggle">
    <button type="button" class="view-toggle-btn active" data-view="table">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
      Tabuľka
    </button>
    <button type="button" class="view-toggle-btn" data-view="grid">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
      Karty
    </button>
  </div>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPartnerModal">Pridať partnera</button>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/partners.css') }}">
{% endblock %}

{% block content %}

{# Grid View #}
<div class="partner-grid-view" style="display: none;">
  <div class="partner-cards-grid">
    {% for partner in partners %}
    <div class="partner-card">
      <div class="partner-card-header">
        <div>
          <h3 class="partner-card-name">{{ partner.name }}</h3>
          {% if partner.ico %}
          <div style="font-size: 12px; color: #888; margin-top: 4px;">IČO: {{ partner.ico }}</div>
          {% endif %}
        </div>
        <div class="partner-card-status">
          {% if partner.is_active %}
            <span class="badge badge-success">Aktívny</span>
          {% else %}
            <span class="badge badge-inactive">Neaktívny</span>
          {% endif %}
        </div>
      </div>

      <div class="partner-card-info">
        {% if partner.street or partner.city %}
        <div class="partner-card-info-row">
          <svg class="partner-card-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span>{{ partner.street }} {{ partner.street_number }}, {{ partner.postal_code }} {{ partner.city }}</span>
        </div>
        {% endif %}

        {% if partner.email %}
        <div class="partner-card-info-row">
          <svg class="partner-card-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          <span>{{ partner.email }}</span>
        </div>
        {% endif %}

        {% if partner.phone %}
        <div class="partner-card-info-row">
          <svg class="partner-card-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          <span>{{ partner.phone }}</span>
        </div>
        {% endif %}
      </div>

      <div class="partner-card-divider"></div>

      <div class="partner-card-meta">
        {% if partner.ico %}
        <div class="partner-card-meta-item">
          <strong>IČO:</strong> {{ partner.ico }}
        </div>
        {% endif %}
        {% if partner.dic %}
        <div class="partner-card-meta-item">
          <strong>DIČ:</strong> {{ partner.dic }}
        </div>
        {% endif %}
        {% if partner.group_code %}
        <div class="partner-card-meta-item">
          <strong>Skupina:</strong> {{ partner.group_code }}
        </div>
        {% endif %}
        {% if partner.discount_percent %}
        <div class="partner-card-meta-item">
          <strong>Zľava:</strong> {{ partner.discount_percent }}%
        </div>
        {% endif %}
      </div>

      <div class="partner-card-actions">
        <button type="button" class="btn btn-outline btn-sm"
          data-bs-toggle="modal" data-bs-target="#viewPartnerModal"
          data-name="{{ partner.name or '' }}"
          data-note="{{ partner.note or '' }}"
          data-email="{{ partner.email or '' }}"
          data-phone="{{ partner.phone or '' }}"
          data-street="{{ partner.street or '' }}"
          data-street-number="{{ partner.street_number or '' }}"
          data-postal-code="{{ partner.postal_code or '' }}"
          data-city="{{ partner.city or '' }}"
          data-ico="{{ partner.ico or '' }}"
          data-dic="{{ partner.dic or '' }}"
          data-ic-dph="{{ partner.ic_dph or '' }}"
          data-group-code="{{ partner.group_code or '' }}"
          data-price-level="{{ partner.price_level or '' }}"
          data-discount-percent="{{ partner.discount_percent }}"
          data-is-active="{{ 1 if partner.is_active else 0 }}">
          Detail
        </button>
        <button type="button" class="btn btn-dark btn-sm"
          data-bs-toggle="modal" data-bs-target="#editPartnerModal"
          data-id="{{ partner.id }}"
          data-name="{{ partner.name or '' }}"
          data-email="{{ partner.email or '' }}"
          data-phone="{{ partner.phone or '' }}"
          data-street="{{ partner.street or '' }}"
          data-street-number="{{ partner.street_number or '' }}"
          data-postal-code="{{ partner.postal_code or '' }}"
          data-city="{{ partner.city or '' }}"
          data-ico="{{ partner.ico or '' }}"
          data-dic="{{ partner.dic or '' }}"
          data-ic-dph="{{ partner.ic_dph or '' }}"
          data-group-code="{{ partner.group_code or '' }}"
          data-price-level="{{ partner.price_level or '' }}"
          data-discount-percent="{{ partner.discount_percent }}"
          data-note="{{ partner.note or '' }}">
          Upraviť
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

{# Table View #}
<div class="partner-table-view">

<div class="modal fade" id="addPartnerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nový partner</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Názov partnera</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input class="form-control" name="email">
            </div>
            <div class="col-md-4">
              <label class="form-label">Telefón</label>
              <input class="form-control" name="phone">
            </div>
            <div class="col-md-3">
              <label class="form-label">Ulica</label>
              <input class="form-control" name="street">
            </div>
            <div class="col-md-2">
              <label class="form-label">Číslo</label>
              <input class="form-control" name="street_number">
            </div>
            <div class="col-md-2">
              <label class="form-label">PSČ</label>
              <input class="form-control" name="postal_code">
            </div>
            <div class="col-md-3">
              <label class="form-label">Mesto</label>
              <input class="form-control" name="city">
            </div>
            <div class="col-md-2">
              <label class="form-label">IČO</label>
              <input class="form-control" name="ico">
            </div>
            <div class="col-md-2">
              <label class="form-label">DIČ</label>
              <input class="form-control" name="dic">
            </div>
            <div class="col-md-2">
              <label class="form-label">IČ DPH</label>
              <input class="form-control" name="ic_dph">
            </div>
            <div class="col-md-2">
              <label class="form-label">Skupina</label>
              <input class="form-control" name="group_code">
            </div>
            <div class="col-md-2">
              <label class="form-label">Cenová hladina</label>
              <input class="form-control" name="price_level">
            </div>
            <div class="col-md-2">
              <label class="form-label">Zľava %</label>
              <input class="form-control" name="discount_percent" type="number" step="0.1">
            </div>
            <div class="col-md-8">
              <label class="form-label">Poznámka</label>
              <input class="form-control" name="note">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Uložiť partnera</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editPartnerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editPartnerForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť partnera</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Názov partnera</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input class="form-control" name="email">
            </div>
            <div class="col-md-4">
              <label class="form-label">Telefón</label>
              <input class="form-control" name="phone">
            </div>
            <div class="col-md-3">
              <label class="form-label">Ulica</label>
              <input class="form-control" name="street">
            </div>
            <div class="col-md-2">
              <label class="form-label">Číslo</label>
              <input class="form-control" name="street_number">
            </div>
            <div class="col-md-2">
              <label class="form-label">PSČ</label>
              <input class="form-control" name="postal_code">
            </div>
            <div class="col-md-3">
              <label class="form-label">Mesto</label>
              <input class="form-control" name="city">
            </div>
            <div class="col-md-2">
              <label class="form-label">IČO</label>
              <input class="form-control" name="ico">
            </div>
            <div class="col-md-2">
              <label class="form-label">DIČ</label>
              <input class="form-control" name="dic">
            </div>
            <div class="col-md-2">
              <label class="form-label">IČ DPH</label>
              <input class="form-control" name="ic_dph">
            </div>
            <div class="col-md-2">
              <label class="form-label">Skupina</label>
              <input class="form-control" name="group_code">
            </div>
            <div class="col-md-2">
              <label class="form-label">Cenová hladina</label>
              <input class="form-control" name="price_level">
            </div>
            <div class="col-md-2">
              <label class="form-label">Zľava %</label>
              <input class="form-control" name="discount_percent" type="number" step="0.1">
            </div>
            <div class="col-md-8">
              <label class="form-label">Poznámka</label>
              <input class="form-control" name="note">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="viewPartnerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail partnera</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Názov</dt><dd class="col-sm-8" id="viewPartnerName"></dd>
          <dt class="col-sm-4">Poznámka</dt><dd class="col-sm-8" id="viewPartnerNote"></dd>
          <dt class="col-sm-4">Email</dt><dd class="col-sm-8" id="viewPartnerEmail"></dd>
          <dt class="col-sm-4">Telefón</dt><dd class="col-sm-8" id="viewPartnerPhone"></dd>
          <dt class="col-sm-4">Ulica</dt><dd class="col-sm-8" id="viewPartnerStreet"></dd>
          <dt class="col-sm-4">PSČ / Mesto</dt><dd class="col-sm-8" id="viewPartnerCity"></dd>
          <dt class="col-sm-4">IČO</dt><dd class="col-sm-8" id="viewPartnerIco"></dd>
          <dt class="col-sm-4">DIČ</dt><dd class="col-sm-8" id="viewPartnerDic"></dd>
          <dt class="col-sm-4">IČ DPH</dt><dd class="col-sm-8" id="viewPartnerIcDph"></dd>
          <dt class="col-sm-4">Skupina</dt><dd class="col-sm-8" id="viewPartnerGroupCode"></dd>
          <dt class="col-sm-4">Cenová hladina</dt><dd class="col-sm-8" id="viewPartnerPriceLevel"></dd>
          <dt class="col-sm-4">Zľava %</dt><dd class="col-sm-8" id="viewPartnerDiscount"></dd>
          <dt class="col-sm-4">Stav</dt><dd class="col-sm-8" id="viewPartnerStatus"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>
<table class="table table-striped bg-white shadow-sm">
  <thead>
    <tr class="table-filter">
      <th></th>
      <th><input type="text" class="form-control form-control-sm" data-col="1" placeholder="Názov..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="2" placeholder="Adresa..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="3" placeholder="IČO..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="4" placeholder="DIČ..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="5" placeholder="IČ DPH..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="6" placeholder="Skupina..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="7" placeholder="Cena/Zľava..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="8" placeholder="Kontakty..."></th>
      <th><input type="text" class="form-control form-control-sm" data-col="9" placeholder="Adresy..."></th>
    </tr>
    <tr>
      <th>Akcie</th>
      <th>Názov</th>
      <th>Adresa</th>
      <th>IČO</th>
      <th>DIČ</th>
      <th>IČ DPH</th>
      <th>Skupina</th>
      <th>Cena/Zľava</th>
      <th>Kontakty</th>
      <th>Adresy</th>
    </tr>
  </thead>
  <tbody>
    {% for partner in partners %}
    <tr>
      <td class="actions-col">
        <button type="button" class="btn btn-sm btn-outline-info"
          data-bs-toggle="modal" data-bs-target="#viewPartnerModal"
          data-name="{{ partner.name or '' }}"
          data-note="{{ partner.note or '' }}"
          data-email="{{ partner.email or '' }}"
          data-phone="{{ partner.phone or '' }}"
          data-street="{{ partner.street or '' }}"
          data-street-number="{{ partner.street_number or '' }}"
          data-postal-code="{{ partner.postal_code or '' }}"
          data-city="{{ partner.city or '' }}"
          data-ico="{{ partner.ico or '' }}"
          data-dic="{{ partner.dic or '' }}"
          data-ic-dph="{{ partner.ic_dph or '' }}"
          data-group-code="{{ partner.group_code or '' }}"
          data-price-level="{{ partner.price_level or '' }}"
          data-discount-percent="{{ partner.discount_percent }}"
          data-is-active="{{ 1 if partner.is_active else 0 }}">Zobraziť</button>
        {% if not partner.is_active %}
        <span class="badge bg-secondary">Neaktívny</span>
        {% endif %}
        <form method="post" action="{{ url_for('partners.toggle_partner', partner_id=partner.id) }}">
          {% if partner.is_active %}
            <button class="btn btn-sm btn-outline-warning" type="submit">Deaktivovať</button>
          {% else %}
            <button class="btn btn-sm btn-outline-success" type="submit">Aktivovať</button>
          {% endif %}
        </form>
        <button type="button" class="btn btn-sm btn-outline-primary"
          data-bs-toggle="modal" data-bs-target="#editPartnerModal"
          data-id="{{ partner.id }}"
          data-name="{{ partner.name or '' }}"
          data-email="{{ partner.email or '' }}"
          data-phone="{{ partner.phone or '' }}"
          data-street="{{ partner.street or '' }}"
          data-street-number="{{ partner.street_number or '' }}"
          data-postal-code="{{ partner.postal_code or '' }}"
          data-city="{{ partner.city or '' }}"
          data-ico="{{ partner.ico or '' }}"
          data-dic="{{ partner.dic or '' }}"
          data-ic-dph="{{ partner.ic_dph or '' }}"
          data-group-code="{{ partner.group_code or '' }}"
          data-price-level="{{ partner.price_level or '' }}"
          data-discount-percent="{{ partner.discount_percent }}"
          data-note="{{ partner.note or '' }}">Upraviť</button>
        <form method="post" action="{{ url_for('partners.delete_partner', partner_id=partner.id) }}"
              onsubmit="return confirm('Naozaj chcete vymazať tohto partnera? Existujúce doklady budú uzamknuté.')">
          <button class="btn btn-sm btn-outline-danger" type="submit">Vymazať</button>
        </form>
      </td>
      <td>{{ partner.name }}</td>
      <td>
        {{ partner.street }} {{ partner.street_number }}<br>
        {{ partner.postal_code }} {{ partner.city }}<br>
        {{ partner.email }} / {{ partner.phone }}
      </td>
      <td>{{ partner.ico }}</td>
      <td>{{ partner.dic }}</td>
      <td>{{ partner.ic_dph }}</td>
      <td>{{ partner.group_code }}</td>
      <td>{{ partner.price_level }} / {{ partner.discount_percent }} %</td>
      <td>
        <button type="button" class="btn btn-sm btn-outline-info"
          data-bs-toggle="modal" data-bs-target="#contactsModal"
          data-partner-id="{{ partner.id }}"
          data-partner-name="{{ partner.name }}">Kontakty ({{ partner.contacts|length }})</button>
      </td>
      <td>
        <ul class="list-unstyled mb-2">
          {% for address in partner.addresses %}
          <li>
            <strong>{{ address.address_type }}</strong>
            {% if address.related_partner %}
              ({{ address.related_partner.name }})
            {% endif %}
            <br>
            {{ address.street }} {{ address.street_number }}, {{ address.postal_code }} {{ address.city }}
          </li>
          {% endfor %}
        </ul>
        <form method="post" action="{{ url_for('partners.add_address', partner_id=partner.id) }}" class="row g-2">
          <div class="col-6">
            <select class="form-select form-select-sm" name="address_type">
              <option value="headquarters">Sídlo</option>
              <option value="ordering">Objednávacia</option>
              <option value="delivery">Dodacia</option>
              <option value="invoice">Fakturačná</option>
              <option value="other">Iná</option>
            </select>
          </div>
          <div class="col-6">
            <input class="form-control form-control-sm" name="related_partner_id" placeholder="ID partnera (voliteľné)">
          </div>
          <div class="col-6"><input class="form-control form-control-sm" name="street" placeholder="Ulica"></div>
          <div class="col-3"><input class="form-control form-control-sm" name="street_number" placeholder="Číslo"></div>
          <div class="col-3"><input class="form-control form-control-sm" name="postal_code" placeholder="PSČ"></div>
          <div class="col-6"><input class="form-control form-control-sm" name="city" placeholder="Mesto"></div>
          <div class="col-12"><button class="btn btn-sm btn-outline-primary" type="submit">Pridať adresu</button></div>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="modal fade" id="contactsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kontakty — <span id="contactsPartnerName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="contactsList"></div>
        <hr>
        <button type="button" class="btn btn-sm btn-primary" id="addContactFromModal">+ Pridať kontakt</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addContactModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addContactForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nový kontakt</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Meno</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Rola</label>
              <input class="form-control" name="role">
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input class="form-control" name="email">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefón</label>
              <input class="form-control" name="phone">
            </div>
            <div class="col-12">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="can_order" id="addContactCanOrder">
                <label class="form-check-label" for="addContactCanOrder">Objednáva</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="can_receive" id="addContactCanReceive">
                <label class="form-check-label" for="addContactCanReceive">Preberá</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Pridať kontakt</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="editContactModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editContactForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Upraviť kontakt</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Meno</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Rola</label>
              <input class="form-control" name="role">
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input class="form-control" name="email">
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefón</label>
              <input class="form-control" name="phone">
            </div>
            <div class="col-12">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="can_order" id="editContactCanOrder">
                <label class="form-check-label" for="editContactCanOrder">Objednáva</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="can_receive" id="editContactCanReceive">
                <label class="form-check-label" for="editContactCanReceive">Preberá</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Uložiť zmeny</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
var partnerContacts = {{ partner_contacts_json|safe }};
var canManageAll = {{ "true" if "manage_all" in user_permissions else "false" }};
var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

function escapeAttr(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML.replace(/"/g, '&quot;');
}

document.getElementById('contactsModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var partnerId = btn.dataset.partnerId;
  this.querySelector('#contactsPartnerName').textContent = btn.dataset.partnerName;
  this.querySelector('#addContactFromModal').dataset.partnerId = partnerId;
  var contacts = partnerContacts[partnerId] || [];
  var container = this.querySelector('#contactsList');

  // Clear previous content safely
  while (container.firstChild) container.removeChild(container.firstChild);

  if (contacts.length === 0) {
    var p = document.createElement('p');
    p.className = 'text-muted';
    p.textContent = 'Žiadne kontakty.';
    container.appendChild(p);
  } else {
    var table = document.createElement('table');
    table.className = 'table table-sm';
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    ['Meno','Rola','Email','Telefón','Oprávnenia','Akcie'].forEach(function(h) {
      var th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');

    contacts.forEach(function(c) {
      var tr = document.createElement('tr');

      // Text cells
      [c.name, c.role, c.email, c.phone].forEach(function(val) {
        var td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });

      // Badges cell
      var badgesTd = document.createElement('td');
      if (c.canOrder) {
        var b1 = document.createElement('span');
        b1.className = 'badge bg-info me-1';
        b1.textContent = 'Objednáva';
        badgesTd.appendChild(b1);
      }
      if (c.canReceive) {
        var b2 = document.createElement('span');
        b2.className = 'badge bg-info';
        b2.textContent = 'Preberá';
        badgesTd.appendChild(b2);
      }
      tr.appendChild(badgesTd);

      // Actions cell
      var actionsTd = document.createElement('td');
      actionsTd.className = 'text-nowrap';

      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'btn btn-sm btn-outline-primary me-1 edit-contact-btn';
      editBtn.textContent = 'Upraviť';
      editBtn.dataset.partnerId = partnerId;
      editBtn.dataset.contactId = c.id;
      editBtn.dataset.name = c.name;
      editBtn.dataset.role = c.role;
      editBtn.dataset.email = c.email;
      editBtn.dataset.phone = c.phone;
      editBtn.dataset.canOrder = c.canOrder ? '1' : '0';
      editBtn.dataset.canReceive = c.canReceive ? '1' : '0';
      actionsTd.appendChild(editBtn);

      if (canManageAll) {
        var delForm = document.createElement('form');
        delForm.method = 'post';
        delForm.action = '/partners/' + partnerId + '/contacts/' + c.id + '/delete';
        delForm.className = 'd-inline';
        delForm.onsubmit = function() { return confirm('Vymazať kontakt?'); };
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        delForm.appendChild(csrfInput);
        var delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-outline-danger';
        delBtn.type = 'submit';
        delBtn.textContent = 'Vymazať';
        delForm.appendChild(delBtn);
        actionsTd.appendChild(delForm);
      }

      tr.appendChild(actionsTd);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }
});
document.getElementById('contactsList').addEventListener('click', function(e) {
  var btn = e.target.closest('.edit-contact-btn');
  if (!btn) return;
  bootstrap.Modal.getInstance(document.getElementById('contactsModal')).hide();
  var editModal = new bootstrap.Modal(document.getElementById('editContactModal'));
  var form = document.getElementById('editContactForm');
  form.action = '/partners/' + btn.dataset.partnerId + '/contacts/' + btn.dataset.contactId + '/edit';
  form.querySelector('[name="name"]').value = btn.dataset.name || '';
  form.querySelector('[name="role"]').value = btn.dataset.role || '';
  form.querySelector('[name="email"]').value = btn.dataset.email || '';
  form.querySelector('[name="phone"]').value = btn.dataset.phone || '';
  form.querySelector('#editContactCanOrder').checked = btn.dataset.canOrder === '1';
  form.querySelector('#editContactCanReceive').checked = btn.dataset.canReceive === '1';
  editModal.show();
});
document.getElementById('addContactFromModal').addEventListener('click', function() {
  bootstrap.Modal.getInstance(document.getElementById('contactsModal')).hide();
  var addModal = new bootstrap.Modal(document.getElementById('addContactModal'));
  var form = document.getElementById('addContactForm');
  form.action = '/partners/' + this.dataset.partnerId + '/contacts';
  form.querySelector('[name="name"]').value = '';
  form.querySelector('[name="role"]').value = '';
  form.querySelector('[name="email"]').value = '';
  form.querySelector('[name="phone"]').value = '';
  form.querySelector('#addContactCanOrder').checked = false;
  form.querySelector('#addContactCanReceive').checked = false;
  addModal.show();
});
document.getElementById('viewPartnerModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  this.querySelector('#viewPartnerName').textContent = btn.dataset.name || '-';
  this.querySelector('#viewPartnerNote').textContent = btn.dataset.note || '-';
  this.querySelector('#viewPartnerEmail').textContent = btn.dataset.email || '-';
  this.querySelector('#viewPartnerPhone').textContent = btn.dataset.phone || '-';
  this.querySelector('#viewPartnerStreet').textContent = (btn.dataset.street || '') + ' ' + (btn.dataset.streetNumber || '');
  this.querySelector('#viewPartnerCity').textContent = (btn.dataset.postalCode || '') + ' ' + (btn.dataset.city || '');
  this.querySelector('#viewPartnerIco').textContent = btn.dataset.ico || '-';
  this.querySelector('#viewPartnerDic').textContent = btn.dataset.dic || '-';
  this.querySelector('#viewPartnerIcDph').textContent = btn.dataset.icDph || '-';
  this.querySelector('#viewPartnerGroupCode').textContent = btn.dataset.groupCode || '-';
  this.querySelector('#viewPartnerPriceLevel').textContent = btn.dataset.priceLevel || '-';
  this.querySelector('#viewPartnerDiscount').textContent = btn.dataset.discountPercent || '0';
  this.querySelector('#viewPartnerStatus').textContent = btn.dataset.isActive === '1' ? 'Aktívny' : 'Neaktívny';
});
document.getElementById('editPartnerModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var form = this.querySelector('form');
  form.action = '/partners/' + btn.dataset.id + '/edit';
  form.querySelector('[name="name"]').value = btn.dataset.name || '';
  form.querySelector('[name="email"]').value = btn.dataset.email || '';
  form.querySelector('[name="phone"]').value = btn.dataset.phone || '';
  form.querySelector('[name="street"]').value = btn.dataset.street || '';
  form.querySelector('[name="street_number"]').value = btn.dataset.streetNumber || '';
  form.querySelector('[name="postal_code"]').value = btn.dataset.postalCode || '';
  form.querySelector('[name="city"]').value = btn.dataset.city || '';
  form.querySelector('[name="ico"]').value = btn.dataset.ico || '';
  form.querySelector('[name="dic"]').value = btn.dataset.dic || '';
  form.querySelector('[name="ic_dph"]').value = btn.dataset.icDph || '';
  form.querySelector('[name="group_code"]').value = btn.dataset.groupCode || '';
  form.querySelector('[name="price_level"]').value = btn.dataset.priceLevel || '';
  form.querySelector('[name="discount_percent"]').value = btn.dataset.discountPercent || '';
  form.querySelector('[name="note"]').value = btn.dataset.note || '';
});

// View toggle functionality
document.querySelectorAll('.view-toggle-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const view = this.dataset.view;

    // Update active state
    document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    // Toggle views
    const gridView = document.querySelector('.partner-grid-view');
    const tableView = document.querySelector('.partner-table-view');

    if (view === 'grid') {
      gridView.style.display = 'block';
      tableView.style.display = 'none';
      localStorage.setItem('partnersView', 'grid');
    } else {
      gridView.style.display = 'none';
      tableView.style.display = 'block';
      localStorage.setItem('partnersView', 'table');
    }
  });
});

// Restore saved view preference
const savedView = localStorage.getItem('partnersView');
if (savedView === 'grid') {
  const gridView = document.querySelector('.partner-grid-view');
  const tableView = document.querySelector('.partner-table-view');
  gridView.style.display = 'block';
  tableView.style.display = 'none';
  document.querySelector('.view-toggle-btn[data-view="grid"]').classList.add('active');
  document.querySelector('.view-toggle-btn[data-view="table"]').classList.remove('active');
}
</script>

</div>{# End partner-table-view #}

{% endblock %}
