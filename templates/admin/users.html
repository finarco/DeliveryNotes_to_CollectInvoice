{% extends "base.html" %}

{% block page_title %}Administrácia{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">Nový používateľ</button>
{% endblock %}

{% block content %}
{% include 'components/admin_nav.html' %}

{# Stats Cards #}
<div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
  <div class="card">
    <div class="card-title">Aktívni používatelia</div>
    <div class="card-value">{{ active_user_count|default(users|selectattr('is_active')|list|length) }}</div>
  </div>
  <div class="card">
    <div class="card-title">Roly</div>
    <div class="card-value">{{ role_count|default(valid_roles|length) }}</div>
  </div>
  <div class="card">
    <div class="card-title">Celkom používateľov</div>
    <div class="card-value">{{ users|length }}</div>
  </div>
</div>

{# Add User Modal #}
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        <div class="modal-header">
          <h5 class="modal-title">Nový používateľ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Meno</label>
              <input class="form-control" name="username" placeholder="Prihlasovacie meno" required>
            </div>
            <div class="col-md-12">
              <label class="form-label">Heslo</label>
              <input class="form-control" type="password" name="password" placeholder="Min. 8 znakov" required minlength="8">
            </div>
            <div class="col-md-12">
              <label class="form-label">Rola</label>
              <select class="form-select" name="role">
                {% for role in valid_roles %}
                <option value="{{ role }}">{{ role }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Vytvoriť používateľa</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# View User Modal #}
<div class="modal fade" id="viewUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail používateľa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">ID</dt><dd class="col-sm-8" id="viewUserId"></dd>
          <dt class="col-sm-4">Meno</dt><dd class="col-sm-8" id="viewUserName"></dd>
          <dt class="col-sm-4">Rola</dt><dd class="col-sm-8" id="viewUserRole"></dd>
          <dt class="col-sm-4">Aktívny</dt><dd class="col-sm-8" id="viewUserActive"></dd>
          <dt class="col-sm-4">Vytvorený</dt><dd class="col-sm-8" id="viewUserCreated"></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
      </div>
    </div>
  </div>
</div>

{# Reset Password Modal #}
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="resetPasswordForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Reset hesla — <span id="resetPasswordUsername"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-12">
              <label class="form-label">Nové heslo</label>
              <input class="form-control" type="password" name="new_password" placeholder="Min. 8 znakov, veľké/malé písmeno, číslica" required minlength="8">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavrieť</button>
          <button type="submit" class="btn btn-primary">Resetovať heslo</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Users Table #}
<div class="table-container">
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--color-border);">
    <h3 style="font-family: var(--font-heading); font-size: 16px; font-weight: 700; text-transform: uppercase; margin: 0;">Používatelia</h3>
    <input type="text" class="form-control" placeholder="Hľadať používateľa..." style="width: 250px;" id="userSearchInput">
  </div>
  <table class="table" id="usersTable">
    <thead>
      <tr>
        <th>Meno</th>
        <th>Rola</th>
        <th>Stav</th>
        <th>Vytvorený</th>
        <th>Akcie</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-family: var(--font-heading); font-size: 14px; font-weight: 700; flex-shrink: 0;">
              {{ user.username[0].upper() }}
            </div>
            <span>{{ user.username }}</span>
          </div>
        </td>
        <td><span class="badge badge-info">{{ user.role }}</span></td>
        <td>
          {% if user.is_active %}
            <span class="badge badge-success">Aktívny</span>
          {% else %}
            <span class="badge badge-inactive">Neaktívny</span>
          {% endif %}
        </td>
        <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else '' }}</td>
        <td>
          <div style="display: flex; gap: 4px; flex-wrap: wrap;">
            <button type="button" class="btn btn-sm btn-outline-info"
              data-bs-toggle="modal" data-bs-target="#viewUserModal"
              data-user-id="{{ user.id }}"
              data-username="{{ user.username }}"
              data-role="{{ user.role }}"
              data-is-active="{{ 1 if user.is_active else 0 }}"
              data-created="{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '' }}">Zobraziť</button>
            <form method="post" action="{{ url_for('admin.toggle_user', user_id=user.id) }}" class="d-inline">
              {% if user.is_active %}
                <button class="btn btn-sm btn-outline-warning" type="submit">Deaktivovať</button>
              {% else %}
                <button class="btn btn-sm btn-outline-success" type="submit">Aktivovať</button>
              {% endif %}
            </form>
            <button class="btn btn-sm btn-outline-info" type="button"
              data-bs-toggle="modal" data-bs-target="#resetPasswordModal"
              data-user-id="{{ user.id }}"
              data-username="{{ user.username }}">
              Reset hesla
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.getElementById('resetPasswordModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  var userId = btn.dataset.userId;
  var username = btn.dataset.username;
  this.querySelector('#resetPasswordUsername').textContent = username;
  this.querySelector('form').action = '{{ url_for("admin.reset_password", user_id=0) }}'.replace('/0/', '/' + userId + '/');
  this.querySelector('[name="new_password"]').value = '';
});

document.getElementById('viewUserModal').addEventListener('show.bs.modal', function(event) {
  var btn = event.relatedTarget;
  this.querySelector('#viewUserId').textContent = btn.dataset.userId || '-';
  this.querySelector('#viewUserName').textContent = btn.dataset.username || '-';
  this.querySelector('#viewUserRole').textContent = btn.dataset.role || '-';
  this.querySelector('#viewUserActive').textContent = btn.dataset.isActive === '1' ? 'Áno' : 'Nie';
  this.querySelector('#viewUserCreated').textContent = btn.dataset.created || '-';
});

// Search functionality
document.getElementById('userSearchInput').addEventListener('input', function() {
  var val = this.value.toLowerCase().trim();
  var rows = document.querySelectorAll('#usersTable tbody tr');
  rows.forEach(function(row) {
    var text = row.textContent.toLowerCase();
    row.style.display = text.indexOf(val) !== -1 ? '' : 'none';
  });
});
</script>
{% endblock %}
